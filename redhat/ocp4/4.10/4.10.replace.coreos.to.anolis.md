# 替换 openshift 底层操作系统为 龙蜥

我们知道，openshift 底层操作系统是基于 rhel 的 rhcos，在当前国内国产化操作系统的大潮之下，我们能不能把 rhcos 换成基于龙蜥制作的 openanolis-coreos呢？答案是可以的，本文作者就带大家一步一步的做一个基于 openanolis 的 openshift 4.10 发行版出来。

# 龙蜥内核编译

龙蜥编译内核很简单，官方有文档，而且很贴心的制作了辅助工具：
- https://openanolis.cn/sig/Cloud-Kernel/doc/607593708787100770?preview=

我们使用openanolis 8.8版本，内核是kernel 5.10的。但是默认内核是不能在coreos上安装的，我们需要定制。作者已经把定制好的项目一起发布了。定制的内容页不复杂，就是post-action需要屏蔽2个命令。

```bash
# in a openanolis vm
yum groupinstall "development tools" -y
yum install -y audit-libs-devel binutils-devel java-devel ncurses-devel newt-devel numactl-devel openssl-devel pciutils-devel perl perl-devel xmlto python3-docutils dwarves bc elfutils-devel python3-devel rsync net-tools

mkdir -p /root/dev
cd /root/dev

# git clone https://gitee.com/anolis/cloud-kernel.git -b devel-5.10

git clone https://gitee.com/wangzheng422/ck-build.git -b an8-5.10

cd ck-build
ln -s ../cloud-kernel cloud-kernel

# remove grubby command from kernel.spec

BUILD_NUMBER='5gc' BUILD_VARIANT='default' BUILD_EXTRA='base' ./build.sh

```
做好了内核rpm，我们可以直接在ocp node上试试。
```bash
# try them out on ocp
# on master-01
mkdir -p /root/down
cd /root/down

curl -O http://192.168.77.11:5000/anolis/core/kernel-5.10.134-core.git.868a8003184f.an8.x86_64.rpm
curl -O http://192.168.77.11:5000/anolis/core/kernel-core-5.10.134-core.git.868a8003184f.an8.x86_64.rpm
curl -O http://192.168.77.11:5000/anolis/core/kernel-modules-5.10.134-core.git.868a8003184f.an8.x86_64.rpm
curl -O http://192.168.77.11:5000/anolis/core/kernel-modules-extra-5.10.134-core.git.868a8003184f.an8.x86_64.rpm

rpm-ostree override replace kernel{,-core,-modules,-modules-extra}-5.10.134-core.git.868a8003184f.an8.x86_64.rpm

# good, it is ok

```

# repo 源制作


# openanolis-coreos 制作


# 基于 openanolis 的 openshift 4.10 发行版制作


# 安装测试