<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>添加 win10 worker 节点 - OpenShift4 慢慢走</title>
        <!-- Custom HTML head -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E3FRMDB7L2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E3FRMDB7L2');
</script>        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">介绍</a></li><li class="chapter-item expanded "><a href="../../install.html"><strong aria-hidden="true">1.</strong> openshift4 安装系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.pull.secret.html"><strong aria-hidden="true">1.1.</strong> 如何获得 openshift4 免费下载密钥</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.build.dist.html"><strong aria-hidden="true">1.2.</strong> openshift4 离线安装介质的制作</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.static.ip.local.assisted.connected.html"><strong aria-hidden="true">1.3.</strong> assisted install 联线模式下 单节点ocp 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.static.ip.local.assisted.disconnected.html"><strong aria-hidden="true">1.4.</strong> assisted install 离线模式下 单节点ocp 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.upi.static.ip.on.rhel7.html"><strong aria-hidden="true">1.5.</strong> openshift4 rhel7物理机 baremetal UPI模式 离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.upi.static.ip.on.rhel8.html"><strong aria-hidden="true">1.6.</strong> openshift4 rhel8物理机 baremetal UPI模式 离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.ipi.on.rhel8.html"><strong aria-hidden="true">1.7.</strong> openshift4 物理机 baremetal IPI模式 离线安装 单网络模式</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.ipi.on.rhel8.provisionning.network.html"><strong aria-hidden="true">1.8.</strong> openshift4 物理机 baremetal IPI模式 离线安装 双网络模式</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.cilium.html"><strong aria-hidden="true">1.9.</strong> openshift4 尝鲜 cilium CNI</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.nvidia.gpu.disconnected.html"><strong aria-hidden="true">1.10.</strong> nvidia gpu for openshift 4.6 disconnected 英伟达GPU离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.add.image.html"><strong aria-hidden="true">1.11.</strong> openshift4 初始安装后 补充镜像</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.is.sample.html"><strong aria-hidden="true">1.12.</strong> openshift4 补充samples operator 需要的 image stream</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.calico.html"><strong aria-hidden="true">1.13.</strong> openshift4 calico 离线部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.2/4.2.upgrade.html"><strong aria-hidden="true">1.14.</strong> openshift4 集群升级</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.shrink.sysroot.html"><strong aria-hidden="true">1.15.</strong> 缩小根分区 / sysroot 的大小</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.update.service.html"><strong aria-hidden="true">1.16.</strong> 部署升级服务 完善离线升级功能</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.windows.node.html" class="active"><strong aria-hidden="true">1.17.</strong> 添加 win10 worker 节点</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.using.bootstrap.disconnected.html"><strong aria-hidden="true">1.18.</strong> 单节点ocp 安装 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.disconnect.bm.ipi.sno.static.ip.html"><strong aria-hidden="true">1.19.</strong> IPI模式 单节点 离线 单网络模式 安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.acm.ztp.disconnected.auto.html"><strong aria-hidden="true">1.20.</strong> ACM zero touch provision 远程单节点集群 全自动安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.coreos.boot.html"><strong aria-hidden="true">1.21.</strong> coreos 启动和分区挂载分析</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.installer.html"><strong aria-hidden="true">1.22.</strong> openshift4 单节点 命令行安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.partition.quay.html"><strong aria-hidden="true">1.23.</strong> openshift4 单节点 在第一块硬盘上添加更多分区</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.nfs.lvm.html"><strong aria-hidden="true">1.24.</strong> openshift4 单节点 使用 lvm 和 nfs 在集群内提供存储</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.boot.from.linux.html"><strong aria-hidden="true">1.25.</strong> openshift4 单节点 从centos7/8 开始安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.odf.html"><strong aria-hidden="true">1.26.</strong> openshift4 单节点 安装精简版 ODF/ceph</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.replace.coreos.html"><strong aria-hidden="true">1.27.</strong> 定制 rhcos</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.rpm-ostree.install.html"><strong aria-hidden="true">1.28.</strong> rhcos 里面安装 rpm</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.component.version.html"><strong aria-hidden="true">1.29.</strong> openshift 4 组件版本</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.embeded.dns.haproxy.registry.html"><strong aria-hidden="true">1.30.</strong> 内嵌 dns, haproxy, registrty</a></li></ol></li><li class="chapter-item expanded "><a href="../../usage.html"><strong aria-hidden="true">2.</strong> openshift4 使用系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.11/4.11.3node.ipi.for.osp.prod.html"><strong aria-hidden="true">2.1.</strong> 在 openshift 4.11 上安装和运行 openstack</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.flexran.20.11.pf.deploy.html"><strong aria-hidden="true">2.2.</strong> 在openshift4上运行 OpenRAN 无线基站应用</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.netflow.table.html"><strong aria-hidden="true">2.3.</strong> openshift4 可视化 ovs netflow</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.flexran.20.11.html"><strong aria-hidden="true">2.4.</strong> intel o-ran flexran 方案在openshift4上的安装和使用</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.ci.cd.demo.html"><strong aria-hidden="true">2.5.</strong> ci/cd pipeline gitops演示</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.oc.exec.html"><strong aria-hidden="true">2.6.</strong> oc/kubectl exec 原理分析</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.nf.conntrack.html"><strong aria-hidden="true">2.7.</strong> nf_conntrack 在 openshift4.9上的处理</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.load.3rd.part.driver.html"><strong aria-hidden="true">2.8.</strong> 加载第三方设备驱动</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.nep.containerized.helm.html"><strong aria-hidden="true">2.9.</strong> helm chart/helm operator</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.metalb.l2.html"><strong aria-hidden="true">2.10.</strong> 使用 MetalLB 用 Layer2 发布 LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.metalb.html"><strong aria-hidden="true">2.11.</strong> 使用 MetalLB 用 BGP 发布 LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.kata.html"><strong aria-hidden="true">2.12.</strong> kata / 沙盒容器</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.sriov.html"><strong aria-hidden="true">2.13.</strong> 在非官方支持的网卡上，测试SRIOV/DPDK</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.keepalived.operator.html"><strong aria-hidden="true">2.14.</strong> 使用 keepalived 激活 LoadBalancer 服务类型</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.real-time.kernel.html"><strong aria-hidden="true">2.15.</strong> 在节点上启用实时操作系统 real-time kernel</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.install.kmod.driver.html"><strong aria-hidden="true">2.16.</strong> 从容器向宿主机注入内核模块 kmod / driver</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.vgpu.sharing.deploy.html"><strong aria-hidden="true">2.17.</strong> GPU/vGPU 共享</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.headless.service.html"><strong aria-hidden="true">2.18.</strong> openshift headless service讲解</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.volumn.html"><strong aria-hidden="true">2.19.</strong> openshift volumn 存储的各种测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.SupportPodPidsLimit.html"><strong aria-hidden="true">2.20.</strong> openshift 设置 SupportPodPidsLimit 解除 pids 限制</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.sso.html"><strong aria-hidden="true">2.21.</strong> openshift4 配置 SSO 点单认证</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.scc.html"><strong aria-hidden="true">2.22.</strong> openshift4 SCC 相关安全能力测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.recover.node.not.ready.html"><strong aria-hidden="true">2.23.</strong> openshift4 从 node not ready 状态恢复</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.QoS.nic.html"><strong aria-hidden="true">2.24.</strong> openshift4 QoS 能力</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.QoS.nic.high.html"><strong aria-hidden="true">2.25.</strong> openshift4 QoS 在流量压力下的表现</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.proxy.html"><strong aria-hidden="true">2.26.</strong> openshift4 使用 image proxy 来下载镜像</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.numa.html"><strong aria-hidden="true">2.27.</strong> openshift4 NUMA 绑核测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.network.policy.html"><strong aria-hidden="true">2.28.</strong> openshift4 Network Policy 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.multicast.html"><strong aria-hidden="true">2.29.</strong> openshift4 网络多播 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.firewall.html"><strong aria-hidden="true">2.30.</strong> openshift4 配置节点防火墙</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.ldap.html"><strong aria-hidden="true">2.31.</strong> openshift4 集成 ldap</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.image.pull.html"><strong aria-hidden="true">2.32.</strong> openshift4 维护 image pull secret</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.huge.page.html"><strong aria-hidden="true">2.33.</strong> openshift4 使用大页内存 huge page</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.helm.html"><strong aria-hidden="true">2.34.</strong> openshift4 使用 helm</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.haproxy.html"><strong aria-hidden="true">2.35.</strong> openshift4 定制router 支持 TCP ingress</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.grafana.html"><strong aria-hidden="true">2.36.</strong> openshift4 监控能力展示 grafana</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.cpu.manager.html"><strong aria-hidden="true">2.37.</strong> openshift4 CPU 绑核 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.build.config.html"><strong aria-hidden="true">2.38.</strong> openshift4 build config & hpa 自动化编译和自动扩缩容</a></li></ol></li><li class="chapter-item expanded "><a href="../../ccn.html"><strong aria-hidden="true">3.</strong> 应用上云系列教程 CCN</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ccn.devops.deploy.html"><strong aria-hidden="true">3.1.</strong> 应用上云系列教程 containerized cloud native (CCN) for openshift 4.4</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ccn.devops.build.html"><strong aria-hidden="true">3.2.</strong> CCN 安装介质制作 for openshift 4.4</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.ccn.devops.deploy.html"><strong aria-hidden="true">3.3.</strong> 应用上云系列教程 containerized cloud native (CCN) for openshift 4.6</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.ccn.devops.build.html"><strong aria-hidden="true">3.4.</strong> CCN 安装介质制作 for openshift 4.6</a></li></ol></li><li class="chapter-item expanded "><a href="../../rh.cloud.html"><strong aria-hidden="true">4.</strong> 红帽其他产品系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.acm.observ.html"><strong aria-hidden="true">4.1.</strong> ACM observability for openshift 4.10</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.ansible.install.html"><strong aria-hidden="true">4.2.</strong> 离线安装 ansible platform</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.08.virus.html"><strong aria-hidden="true">4.3.</strong> RHACS 应对log4j 原理和实践</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.ocs.cnv.ceph.html"><strong aria-hidden="true">4.4.</strong> openshift承载虚拟化业务(CNV)</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.rhacs.html"><strong aria-hidden="true">4.5.</strong> RHACS / stackrox</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.rhacs.deep.html"><strong aria-hidden="true">4.6.</strong> 为 RHACS 找个应用场景: 安全合规测试云 </a></li></ol></li><li class="chapter-item expanded "><a href="../../os.html"><strong aria-hidden="true">5.</strong> 操作系统相关</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../notes/2022/2022.04.os.backup.ReaR.html"><strong aria-hidden="true">5.1.</strong> Relax and Recover(ReaR) 系统备份和灾难恢复</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.04.no-cost.rhel.sub.html"><strong aria-hidden="true">5.2.</strong> 红帽免费的开发者订阅申请和使用</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.rpm.belongs.html"><strong aria-hidden="true">5.3.</strong> 在红帽官网查询rpm属于哪个repo</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.rhel7.upgrade.to.rhel8.html"><strong aria-hidden="true">5.4.</strong> 离线环境下 原地升级 rhel7-&gt;rhel8</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.sysctl.html"><strong aria-hidden="true">5.5.</strong> 系统启动自动加载sysctl配置</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.12.ocp.bf2.dpi.url.filter.html"><strong aria-hidden="true">5.6.</strong> Mellanox BF2 刷固件并测试DPI URL-filter场景</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.11.bf2.snap.try.html"><strong aria-hidden="true">5.7.</strong> Mellanox BF2 网卡激活snap功能，配置nvme over fabrics 支持</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.10.cx6dx.vdpa.offload.html"><strong aria-hidden="true">5.8.</strong> Mellanox CX6 vdpa 硬件卸载 ovs-kernel 方式</a></li><li class="chapter-item expanded "><a href="../../rhel/rhel.build.kernel.html"><strong aria-hidden="true">5.9.</strong> RHEL8编译定制化内核</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.check.whether.vm.html"><strong aria-hidden="true">5.10.</strong> 检查OS是否是运行在虚拟机上</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ovs.html"><strong aria-hidden="true">5.11.</strong> 两个主机用ovs组网</a></li></ol></li><li class="chapter-item expanded "><a href="../../workshop.html"><strong aria-hidden="true">6.</strong> 优秀的workshop</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.ocs.workshop.html"><strong aria-hidden="true">6.1.</strong> openshift4 & openshift storage workshop</a></li></ol></li><li class="chapter-item expanded "><a href="../../poc.html"><strong aria-hidden="true">7.</strong> POC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.3/poc.sc/install.poc.sc.html"><strong aria-hidden="true">7.1.</strong> 2020.04 某次POC openshift LVM调优</a></li></ol></li><li class="chapter-item expanded "><a href="../../osx.html"><strong aria-hidden="true">8.</strong> OSX使用技巧</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../osx/osx.record.system.audio.html"><strong aria-hidden="true">8.1.</strong> 如何录制系统声音</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OpenShift4 慢慢走</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/wangzheng422/docker_env" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/wangzheng422/docker_env/blob/dev/redhat/ocp4/4.8/4.8.windows.node.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="windows-node-in-openshift-48"><a class="header" href="#windows-node-in-openshift-48">windows node in openshift 4.8</a></h1>
<p>在本文中，我们将安装一个win10节点，并加入到openshift 4.8集群中去。之后会部署一个演示应用。</p>
<p>经过测试，我们发现，当前的win10当作worker节点，还是不太适合，原因如下：</p>
<ul>
<li>windows要求容器的基础镜像版本，和宿主机的版本严格一致，这样就不能向rhel一样，在rhel8上运行rhel7的容器，在部署的时候会造成很大困惑。</li>
<li>windows的容器，不能运行GUI app。虽然也有很多.net的web服务应用，但是更多的老旧windows应用，应该还是包含GUI的程序。这样大大的限制了windows容器的应用访问。</li>
<li>docker for windows版本，只能设置proxy，不能为第三方镜像仓库设置mirror，这样对于离线部署，就很难受了。</li>
<li>目前版本，对静态IP部署还不友好，需要手动配置windows网卡。</li>
<li>目前版本的稳定性还有待加强，会出现k8s的服务崩溃现象，只能做开发测试，体验用，当然如果我们用windows server来做，稳定性会好很多。</li>
</ul>
<p>本次部署的架构图：</p>
<p><img src="./dia/4.8.win.1node.drawio.svg" alt="" /></p>
<p>视频讲解:</p>
<p><a href="https://www.bilibili.com/video/BV1Hf4y1c79D/"><kbd><img src="imgs/2021-10-10-09-47-25.png" width="600"></kbd></a></p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Hf4y1c79D/">bilibili</a></li>
<li><a href="https://youtu.be/Zs7Z-HyEyEI">youtube</a></li>
</ul>
<h1 id="安装-win10"><a class="header" href="#安装-win10">安装 win10</a></h1>
<p>安装win10，需要注意选择正确的版本，因为win10的docker镜像版本，要求和宿主机一致。 <a href="https://hub.docker.com/_/microsoft-windows">在这里查看 win10 docker image version</a>.</p>
<p>在本文撰写的时候，版本是win10 20H2 20H2, <a href="https://www.itechtics.com/download-windows-10-20h2/">在这里找下载这个版本的ISO</a>.</p>
<p>选择好版本，我们就要开始安装了。</p>
<pre><code class="language-bash"># 先要准备一下 virtio 的驱动，因为 win10 里面没有， 安装的时候找不到硬盘。
podman pull registry.redhat.io/container-native-virtualization/virtio-win
podman run --rm -it --name swap registry.redhat.io/container-native-virtualization/virtio-win bash
podman create --name swap registry.redhat.io/container-native-virtualization/virtio-win ls
podman cp swap:/disk/virtio-win.iso - &gt; virtio-win.iso.tar
gzip virtio-win.iso.tar
podman rm swap

# 直接创建kvm, 自动开始安装啦。
export KVM_DIRECTORY=/data/kvm
virt-install --name=ocp4-windows --vcpus=6,cores=6 --ram=12288 \
--cpu=host-model \
--disk path=/data/nvme/ocp4-windows.qcow2,bus=virtio,size=100 \
--os-variant win10 --network bridge=baremetal,model=virtio \
--graphics vnc,port=59017 \
--boot menu=on \
--cdrom ${KVM_DIRECTORY}/win10.iso \
--disk ${KVM_DIRECTORY}/virtio-win.iso,device=cdrom

</code></pre>
<p>win10的话，必须选择专业版。</p>
<p><img src="imgs/2021-09-28-07-51-18.png" alt="" /></p>
<p>选择自定义安装，因为我们要加载硬盘驱动</p>
<p><img src="imgs/2021-09-28-07-51-56.png" alt="" /></p>
<p>选择加载驱动程序</p>
<p><img src="imgs/2021-09-28-07-52-32.png" alt="" /></p>
<p>选择正确的驱动程序位置</p>
<p><img src="imgs/2021-09-28-07-53-21.png" alt="" /></p>
<p>选择驱动，下一步</p>
<p><img src="imgs/2021-09-28-07-53-41.png" alt="" /></p>
<p>默认安装整个硬盘</p>
<p><img src="imgs/2021-09-28-07-54-30.png" alt="" /></p>
<p>安装就自动进行</p>
<p><img src="imgs/2021-09-28-07-54-48.png" alt="" /></p>
<p>安装完成后，进入系统，把剩下的驱动，一口气都装了。</p>
<p><img src="imgs/2021-09-28-08-22-33.png" alt="" /></p>
<p>系统识别出了网卡，那就设置IP地址吧</p>
<p><img src="imgs/2021-09-28-08-28-31.png" alt="" /></p>
<p>我们需要装ssh服务端，从 设置-应用 中找</p>
<p><img src="imgs/2021-09-28-08-29-47.png" alt="" /></p>
<p>点击可选功能</p>
<p><img src="imgs/2021-09-28-08-30-50.png" alt="" /></p>
<!-- 
![](imgs/2021-09-28-08-31-29.png) -->
<p>点击添加功能</p>
<p><img src="imgs/2021-09-28-08-32-27.png" alt="" /></p>
<p>搜索ssh服务器，并安装</p>
<p><img src="imgs/2021-09-28-08-32-57.png" alt="" /></p>
<!-- ![](imgs/2021-09-28-08-42-21.png) -->
<p>安装完了ssh是这样样子的</p>
<p><img src="imgs/2021-09-28-08-44-09.png" alt="" /></p>
<p>我们还需要打开防火墙端口，从网络配置进入</p>
<p><img src="imgs/2021-09-28-09-28-21.png" alt="" /></p>
<p>选择高级设置</p>
<p><img src="imgs/2021-09-28-09-29-03.png" alt="" /></p>
<p>新建入站规则</p>
<p><img src="imgs/2021-09-28-09-53-32.png" alt="" /></p>
<p>根据文档要求，打开 22, 10250 端口</p>
<p><img src="imgs/2021-09-28-09-55-25.png" alt="" /></p>
<p>允许连接</p>
<p><img src="imgs/2021-09-28-09-56-22.png" alt="" /></p>
<p>所有网络位置都允许</p>
<p><img src="imgs/2021-09-28-09-57-00.png" alt="" /></p>
<p>给起个名字</p>
<p><img src="imgs/2021-09-28-09-57-41.png" alt="" /></p>
<!-- ![](imgs/2021-09-28-10-04-17.png) -->
<p>ssh服务不是自动启动了，我们设置成自动启动</p>
<p><img src="imgs/2021-09-28-10-29-16.png" alt="" /></p>
<p>选择自动</p>
<p><img src="imgs/2021-09-28-10-30-08.png" alt="" /></p>
<p>从外面，就能ssh到windows了</p>
<p><img src="imgs/2021-09-28-10-31-24.png" alt="" /></p>
<p>我把实验用的win10，打包到了一个镜像里面，需要的可以下载使用。</p>
<p>用户名密码是: wzh / redhat</p>
<pre><code class="language-bash">ssh wzh@worker-1
# Microsoft Windows [版本 10.0.19043.1237]
# (c) Microsoft Corporation。保留所有权利。

# wzh@DESKTOP-FUIF19L C:\Users\wzh&gt;

</code></pre>
<h2 id="设置-ssh-key-auth"><a class="header" href="#设置-ssh-key-auth">设置 ssh key auth</a></h2>
<p>我们需要设置ssh使用key的方式自动登录，那么要有几个特殊的步骤。</p>
<p>首先，是<a href="https://superuser.com/questions/106360/how-to-enable-execution-of-powershell-scripts">解除win10的powershell的限制</a></p>
<pre><code>Set-ExecutionPolicy unrestricted
</code></pre>
<p>接下来准备2个文件</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package">wsl2 kernel update</a></li>
<li><a href="https://docs.docker.com/desktop/windows/install/">docker install file</a></li>
</ul>
<p><a href="https://www.concurrency.com/blog/may-2019/key-based-authentication-for-openssh-on-windows">参考这个文章</a>，写一个允许ssh自动key登录的脚本，我们在里面还加上了自动激活hyper-v, windows container的步骤。</p>
<pre><code class="language-bash"># the script here also enable hyper-v and windows container
cat &lt;&lt; 'EOF' &gt; /data/install/win-ssh.ps1
$acl = Get-Acl C:\ProgramData\ssh\administrators_authorized_keys
$acl.SetAccessRuleProtection($true, $false)
$administratorsRule = New-Object system.security.accesscontrol.filesystemaccessrule(&quot;Administrators&quot;,&quot;FullControl&quot;,&quot;Allow&quot;)
$systemRule = New-Object system.security.accesscontrol.filesystemaccessrule(&quot;SYSTEM&quot;,&quot;FullControl&quot;,&quot;Allow&quot;)
$acl.SetAccessRule($administratorsRule)
$acl.SetAccessRule($systemRule)
$acl | Set-Acl

Enable-WindowsOptionalFeature -Online -FeatureName $(&quot;Microsoft-Hyper-V&quot;, &quot;Containers&quot;) -All
EOF

# 把脚本, key, 还有安装文件，复制到win10上 
scp /data/install/win-ssh.ps1 wzh@worker-1:c:\\win-ssh.ps1

scp /root/.ssh/id_rsa.pub wzh@worker-1:C:\\ProgramData\\ssh\\administrators_authorized_keys

scp /data/down/Docker\ Desktop\ Installer.exe wzh@worker-1:c:\\docker-install.exe

scp /data/down/wsl_update_x64.msi wzh@worker-1:c:\\wsl_update_x64.msi
</code></pre>
<!-- ![](imgs/2021-09-28-17-36-54.png)

![](imgs/2021-09-28-17-36-18.png) -->
<p>用管理员权限，打开power shell</p>
<p><img src="imgs/2021-09-28-17-57-54.png" alt="" /></p>
<p>运行我们的脚本</p>
<p><img src="imgs/2021-09-28-17-59-35.png" alt="" /></p>
<!-- Restart your openssh server on win10, then you can ssh to you win10 without password. :) -->
<p>重启win10, 然后你就可以用key自动登录啦。</p>
<!-- ## enable hyper-v & windows container

https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v

https://docs.microsoft.com/en-us/virtualization/windowscontainers/quick-start/set-up-environment?tabs=Windows-10

![](imgs/2021-09-28-19-20-05.png)

![](imgs/2021-09-28-19-21-06.png)

![](imgs/2021-09-28-19-25-49.png) -->
<!-- https://hub.docker.com/editions/community/docker-ce-desktop-windows -->
<p>安装docker，并切换到windows container。</p>
<p>第一次启动docker，会说什么wsl2 linux kernel要更新，可以用我提供的文件，直接更新，也可以直接切换windows container，不用理会那个报警。</p>
<!-- remember to switch to "windows container" -->
<p><img src="imgs/2021-09-28-19-59-26.png" alt="" /></p>
<!-- also set the docker's registry mirror, and insecure registry

![](imgs/2021-09-29-17-51-50.png) -->
<p><a href="https://blog.miniasp.com/post/2019/03/22/Enable-process-isolation-by-default-on-Windows-containers/">设置 docker for windows, 使用 process 来隔离</a>, 因为kvm上的某种未知配置错误，默认hyper-v形式的隔离，启动不了容器，我们换成process来隔离.</p>
<pre><code class="language-json">{
  &quot;registry-mirrors&quot;: [],
  &quot;insecure-registries&quot;: [],
  &quot;debug&quot;: true,
  &quot;experimental&quot;: false,
  &quot;exec-opts&quot;: [
    &quot;isolation=process&quot;
  ]
}
</code></pre>
<p>配置界面长这样</p>
<p><img src="imgs/2021-09-30-20-55-00.png" alt="" /></p>
<p>记得改一下windows的主机名</p>
<p><img src="imgs/2021-09-29-11-06-50.png" alt="" /></p>
<h2 id="backup-win10-kvm"><a class="header" href="#backup-win10-kvm">backup win10 kvm</a></h2>
<p>我们备份一下win10 kvm，并上传quay.io，方便以后重新做实验。</p>
<p><a href="https://schh.medium.com/backup-and-restore-kvm-vms-21c049e707c1">我们可以参考这里，来备份和回复kvm。</a></p>
<pre><code class="language-bash"># poweroff you win7 vm

mkdir -p /data/nvme/bak

cd /data/nvme

virsh dumpxml ocp4-windows &gt; /data/nvme/bak/ocp4-windows.xml
pigz -c ocp4-windows.qcow2 &gt; /data/nvme/bak/ocp4-windows.qcow2.gz

cd /data/nvme/bak

var_date=$(date '+%Y-%m-%d-%H%M')
echo $var_date

buildah from --name onbuild-container scratch
buildah copy onbuild-container ocp4-windows.xml  /
buildah copy onbuild-container ocp4-windows.qcow2.gz  /
buildah umount onbuild-container 
buildah commit --rm onbuild-container quay.io/wangzheng422/qimgs:win7-ssh-$var_date
# buildah rm onbuild-container
# rm -f nexus-image.tgz 
echo &quot;quay.io/wangzheng422/qimgs:win7-ssh-$var_date&quot;
buildah push quay.io/wangzheng422/qimgs:win7-ssh-$var_date

# so, we got a image contain win10, and feature enabled.
# this is for win10 versin 10.0.19043.1237
# quay.io/wangzheng422/qimgs:win7-ssh-2021-09-30-1340

</code></pre>
<!-- you can use the image above to extract the win10 image, and run locally, to try the windows node. -->
<p>你可以使用上面的这个版本的镜像，拉取到本地，并从中取出win10虚拟机，然后自己尝试啦。</p>
<h1 id="安装-ocp-使用-ovn-with-hybrid-mode"><a class="header" href="#安装-ocp-使用-ovn-with-hybrid-mode">安装 ocp, 使用 ovn with hybrid mode</a></h1>
<p>参考官方文档：</p>
<ul>
<li>https://docs.openshift.com/container-platform/4.8/windows_containers/byoh-windows-instance.html</li>
<li>https://docs.openshift.com/container-platform/4.8/windows_containers/enabling-windows-container-workloads.html</li>
</ul>
<pre><code class="language-bash">
# vi install-config.yaml 
cat &lt;&lt; EOF &gt; /data/install/install-config.yaml 
apiVersion: v1
baseDomain: redhat.ren
compute:
- hyperthreading: Enabled
  name: worker
  replicas: 0
controlPlane:
  hyperthreading: Enabled
  name: master
  replicas: 1
metadata:
  name: ocp4
networking:
  clusterNetworks:
  - cidr: 10.128.0.0/16
    hostPrefix: 23
  networkType: OVNKubernetes
  serviceNetwork:
  - 172.30.0.0/16
platform:
  none: {}
pullSecret: '{&quot;auths&quot;:{&quot;registry.ocp4.redhat.ren:5443&quot;: {&quot;auth&quot;: &quot;ZHVtbXk6ZHVtbXk=&quot;,&quot;email&quot;: &quot;noemail@localhost&quot;},&quot;registry.ppa.redhat.ren:5443&quot;: {&quot;auth&quot;: &quot;ZHVtbXk6ZHVtbXk=&quot;,&quot;email&quot;: &quot;noemail@localhost&quot;}}}'
sshKey: |
$( cat /root/.ssh/id_rsa.pub | sed 's/^/   /g' )
additionalTrustBundle: |
$( cat /etc/crts/redhat.ren.ca.crt | sed 's/^/   /g' )
imageContentSources:
- mirrors:
  - registry.ocp4.redhat.ren:5443/ocp4/openshift4
  - registry.ocp4.redhat.ren:5443/ocp4/release
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - registry.ocp4.redhat.ren:5443/ocp4/openshift4
  - registry.ocp4.redhat.ren:5443/ocp4/release
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev
EOF

cat &lt;&lt; EOF &gt; /data/install/manifests/cluster-network-03-config.yml
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  defaultNetwork:
    ovnKubernetesConfig:
      hybridOverlayConfig:
        hybridClusterNetwork: 
        - cidr: 10.132.0.0/16
          hostPrefix: 23
        hybridOverlayVXLANPort: 9898 
EOF

</code></pre>
<p>安装windows machien config operator
<img src="imgs/2021-09-28-20-16-19.png" alt="" /></p>
<pre><code class="language-bash"># 导入ssh key
oc create secret generic cloud-private-key --from-file=private-key.pem=/root/.ssh/id_rsa \
    -n openshift-windows-machine-config-operator

# 配置win10自动登录用户名和ip地址
cat &lt;&lt; EOF &gt; /data/install/win-node.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: windows-instances
  namespace: openshift-windows-machine-config-operator
data:
  192.168.7.17: |- 
    username=wzh
EOF
oc create -f /data/install/win-node.yaml

# to restore
oc delete -f /data/install/win-node.yaml

# csr is automatically approved
oc get csr
# NAME                                       AGE   SIGNERNAME                                    REQUESTOR                                                                         CONDITION
# csr-ff7q5                                  63m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         Approved,Issued
# csr-gzlpq                                  53s   kubernetes.io/kubelet-serving                 system:node:worker-1                                                              Approved,Issued
# csr-rgdzv                                  59s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         Approved,Issued
# csr-zkw8c                                  63m   kubernetes.io/kubelet-serving                 system:node:master-0                                                              Approved,Issued
# system:openshift:openshift-authenticator   59m   kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-authentication-operator:authentication-operator   Approved,Issued
</code></pre>
<p>估计是当前实现的bug，或者其他原因，windows的默认网卡，上面的协议会被disable掉，造成windows node加入集群失败，目前暂时手动的把这些协议都enable，只留一个不激活。当然，你也可以只enable ipv4的配置，也是可以的。
<img src="imgs/2021-09-29-11-20-20.png" alt="" /></p>
<p>之后就等着好了，openshift会自动上传程序和配置，并配置好windows node，加入集群，成功以后，我们就能看到如下的日志。</p>
<pre><code class="language-log">{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004643.789956,&quot;logger&quot;:&quot;controllers.configmap&quot;,&quot;msg&quot;:&quot;processing&quot;,&quot;instances in&quot;:&quot;windows-instances&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004674.0080738,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configuring&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004675.3135288,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;transferring files&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004693.670281,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configured&quot;,&quot;service&quot;:&quot;windows_exporter&quot;,&quot;args&quot;:&quot;--collectors.enabled cpu,cs,logical_disk,net,os,service,system,textfile,container,memory,cpu_info\&quot;&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004697.0266535,&quot;logger&quot;:&quot;controllers.CertificateSigningRequests&quot;,&quot;msg&quot;:&quot;CSR approved&quot;,&quot;CSR&quot;:&quot;csr-rgdzv&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004703.104529,&quot;logger&quot;:&quot;controllers.CertificateSigningRequests&quot;,&quot;msg&quot;:&quot;CSR approved&quot;,&quot;CSR&quot;:&quot;csr-gzlpq&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004726.9497287,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configured kubelet&quot;,&quot;cmd&quot;:&quot;C:\\k\\\\wmcb.exe initialize-kubelet --ignition-file C:\\Windows\\Temp\\worker.ign --kubelet-path C:\\k\\kubelet.exe --node-ip=192.168.7.17&quot;,&quot;output&quot;:&quot;Bootstrapping completed successfully&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004757.078427,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configure&quot;,&quot;service&quot;:&quot;hybrid-overlay-node&quot;,&quot;args&quot;:&quot;--node worker-1 --hybrid-overlay-vxlan-port=9898 --k8s-kubeconfig c:\\k\\kubeconfig --windows-service --logfile C:\\var\\log\\hybrid-overlay\\hybrid-overlay.log\&quot; depend= kubelet&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004880.6788793,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configured&quot;,&quot;service&quot;:&quot;hybrid-overlay-node&quot;,&quot;args&quot;:&quot;--node worker-1 --hybrid-overlay-vxlan-port=9898 --k8s-kubeconfig c:\\k\\kubeconfig --windows-service --logfile C:\\var\\log\\hybrid-overlay\\hybrid-overlay.log\&quot; depend= kubelet&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004928.5883121,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configured kubelet for CNI&quot;,&quot;cmd&quot;:&quot;C:\\k\\wmcb.exe configure-cni --cni-dir=\&quot;C:\\k\\cni\\ --cni-config=\&quot;C:\\k\\cni\\config\\cni.conf&quot;,&quot;output&quot;:&quot;CNI configuration completed successfully&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004941.3937094,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;configured&quot;,&quot;service&quot;:&quot;kube-proxy&quot;,&quot;args&quot;:&quot;--windows-service --v=4 --proxy-mode=kernelspace --feature-gates=WinOverlay=true --hostname-override=worker-1 --kubeconfig=c:\\k\\kubeconfig --cluster-cidr=10.132.0.0/24 --log-dir=C:\\var\\log\\kube-proxy\\ --logtostderr=false --network-name=OVNKubernetesHybridOverlayNetwork --source-vip=10.132.0.14 --enable-dsr=false --feature-gates=IPv6DualStack=false\&quot; depend= hybrid-overlay-node&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004956.4613981,&quot;logger&quot;:&quot;nc 192.168.7.17&quot;,&quot;msg&quot;:&quot;instance has been configured as a worker node&quot;,&quot;version&quot;:&quot;3.1.0+06e96071&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004956.4949114,&quot;logger&quot;:&quot;metrics&quot;,&quot;msg&quot;:&quot;Prometheus configured&quot;,&quot;endpoints&quot;:&quot;windows-exporter&quot;,&quot;port&quot;:9182,&quot;name&quot;:&quot;metrics&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004956.5283544,&quot;logger&quot;:&quot;controllers.configmap&quot;,&quot;msg&quot;:&quot;processing&quot;,&quot;instances in&quot;:&quot;windows-instances&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004956.5387952,&quot;logger&quot;:&quot;controllers.configmap&quot;,&quot;msg&quot;:&quot;instance is up to date&quot;,&quot;node&quot;:&quot;worker-1&quot;,&quot;version&quot;:&quot;3.1.0+06e96071&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1633004956.5493839,&quot;logger&quot;:&quot;metrics&quot;,&quot;msg&quot;:&quot;Prometheus configured&quot;,&quot;endpoints&quot;:&quot;windows-exporter&quot;,&quot;port&quot;:9182,&quot;name&quot;:&quot;metrics&quot;}
</code></pre>
<p>我们能看到 windows节点了。</p>
<pre><code class="language-bash">oc get node
# NAME       STATUS   ROLES           AGE     VERSION
# master-0   Ready    master,worker   19h     v1.21.1+a620f50
# worker-1   Ready    worker          4m50s   v1.21.1-1398+98073871f173ba

oc get node --show-labels
# NAME       STATUS   ROLES           AGE     VERSION                       LABELS
# master-0   Ready    master,worker   4h13m   v1.21.1+a620f50               beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master-0,kubernetes.io/os=linux,node-role.kubernetes.io/master=,node-role.kubernetes.io/worker=,node.openshift.io/os_id=rhcos
# worker-1   Ready    worker          5m25s   v1.21.1-1398+98073871f173ba   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=windows,kubernetes.io/arch=amd64,kubernetes.io/hostname=worker-1,kubernetes.io/os=windows,node-role.kubernetes.io/worker=,node.kubernetes.io/windows-build=10.0.19042,node.openshift.io/os_id=Windows,windowsmachineconfig.openshift.io/byoh=true

# 看了windows节点不占用machine config pool
oc get mcp
# NAME     CONFIG                                             UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
# master   rendered-master-607708e411d75c10e680d8bf5e24de6f   True      False      False      1              1                   1                     0                      19h
# worker   rendered-worker-cacf7f7f871c77ae92070b0a44fe0b91   True      False      False      0              0                   0                     0                      19h
</code></pre>
<h2 id="探索一下装了什么"><a class="header" href="#探索一下装了什么">探索一下装了什么</a></h2>
<p>进入win10，可以看到C:\下面，有一个k目录，还有一个var目录，k目录下面就是配置和可执行程序啦。</p>
<pre><code class="language-cmd">wzh@WORKER-1 c:\&gt;dir
 驱动器 C 中的卷没有标签。
 卷的序列号是 C607-13D4

 c:\ 的目录

2021/09/28  19:37       535,444,968 Docker Desktop Installer.exe
2021/09/29  11:12    &lt;DIR&gt;          k
2019/12/07  17:14    &lt;DIR&gt;          PerfLogs
2021/09/28  19:57    &lt;DIR&gt;          Program Files
2021/04/09  21:57    &lt;DIR&gt;          Program Files (x86)
2021/09/29  11:12    &lt;DIR&gt;          Temp
2021/09/28  08:25    &lt;DIR&gt;          Users
2021/09/29  11:11    &lt;DIR&gt;          var
2021/09/28  17:51               428 win-ssh.ps1
2021/09/28  16:34    &lt;DIR&gt;          Windows
               2 个文件    535,445,396 字节
               8 个目录 19,381,813,248 可用字节

wzh@WORKER-1 c:\&gt;dir k
 驱动器 C 中的卷没有标签。
 卷的序列号是 C607-13D4

 c:\k 的目录

2021/09/29  11:12    &lt;DIR&gt;          .
2021/09/29  11:12    &lt;DIR&gt;          ..
2021/09/29  11:12            10,908 bootstrap-kubeconfig
2021/09/29  11:12    &lt;DIR&gt;          cni
2021/09/29  11:12    &lt;DIR&gt;          etc
2021/09/29  11:12        47,493,632 hybrid-overlay-node.exe
2021/09/29  11:12        47,809,536 kube-proxy.exe
2021/09/29  11:12            10,132 kubeconfig
2021/09/29  11:12             5,875 kubelet-ca.crt
2021/09/29  11:12               739 kubelet.conf
2021/09/29  11:12       117,698,048 kubelet.exe
2021/09/29  11:12    &lt;DIR&gt;          usr
2021/09/29  11:12        16,986,112 windows_exporter.exe
2021/09/29  11:12        16,331,776 wmcb.exe
               9 个文件    246,346,758 字节
               5 个目录 19,381,317,632 可用字节

wzh@WORKER-1 c:\&gt;dir var\log
 驱动器 C 中的卷没有标签。
 卷的序列号是 C607-13D4

 c:\var\log 的目录

2021/09/29  11:12    &lt;DIR&gt;          .
2021/09/29  11:12    &lt;DIR&gt;          ..
2021/09/29  11:12    &lt;DIR&gt;          containers
2021/09/29  11:12    &lt;DIR&gt;          hybrid-overlay
2021/09/29  11:16    &lt;DIR&gt;          kube-proxy
2021/09/29  11:12    &lt;DIR&gt;          kubelet
2021/09/29  11:12    &lt;DIR&gt;          pods
               0 个文件              0 字节
               7 个目录 19,381,059,584 可用字节

wzh@WORKER-1 c:\&gt;dir var\lib
 驱动器 C 中的卷没有标签。
 卷的序列号是 C607-13D4

 c:\var\lib 的目录

2021/09/28  20:36    &lt;DIR&gt;          .
2021/09/28  20:36    &lt;DIR&gt;          ..
2021/09/28  20:36    &lt;DIR&gt;          dockershim
2021/09/28  20:38    &lt;DIR&gt;          kubelet
               0 个文件              0 字节
               4 个目录 19,381,043,200 可用字节

</code></pre>
<h2 id="删除windows节点"><a class="header" href="#删除windows节点">删除windows节点</a></h2>
<p>除了官方文档说的，改config map之外，发现，最好还是重启一下windows node为好。</p>
<p>改了config map，耐心等着，最后oc get node，就会看到windows node没有了。</p>
<p>从operator的日志里面，可以看到如下的日志信息。</p>
<pre><code class="language-log">{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916600.248877,&quot;logger&quot;:&quot;controllers.configmap&quot;,&quot;msg&quot;:&quot;processing&quot;,&quot;instances in&quot;:&quot;windows-instances&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916610.646764,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;deconfiguring&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916641.877409,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;deconfigured&quot;,&quot;service&quot;:&quot;windows_exporter&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916672.9587948,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;deconfigured&quot;,&quot;service&quot;:&quot;kube-proxy&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916703.9290483,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;deconfigured&quot;,&quot;service&quot;:&quot;hybrid-overlay-node&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916734.8715909,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;deconfigured&quot;,&quot;service&quot;:&quot;kubelet&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916734.8733184,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;removing directories&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916735.4904935,&quot;logger&quot;:&quot;wc 192.168.7.17&quot;,&quot;msg&quot;:&quot;removing HNS networks&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916924.5720427,&quot;logger&quot;:&quot;nc 192.168.7.17&quot;,&quot;msg&quot;:&quot;instance has been deconfigured&quot;,&quot;node&quot;:&quot;worker-1&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916924.6041753,&quot;logger&quot;:&quot;metrics&quot;,&quot;msg&quot;:&quot;Prometheus configured&quot;,&quot;endpoints&quot;:&quot;windows-exporter&quot;,&quot;port&quot;:9182,&quot;name&quot;:&quot;metrics&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916924.6054258,&quot;logger&quot;:&quot;controllers.configmap&quot;,&quot;msg&quot;:&quot;processing&quot;,&quot;instances in&quot;:&quot;windows-instances&quot;}
{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1632916924.6281445,&quot;logger&quot;:&quot;metrics&quot;,&quot;msg&quot;:&quot;Prometheus configured&quot;,&quot;endpoints&quot;:&quot;windows-exporter&quot;,&quot;port&quot;:9182,&quot;name&quot;:&quot;metrics&quot;}
</code></pre>
<h2 id="resize-qcow2-disk"><a class="header" href="#resize-qcow2-disk">resize qcow2 disk</a></h2>
<p>https://computingforgeeks.com/how-to-extend-increase-kvm-virtual-machine-disk-size/</p>
<pre><code class="language-bash">qemu-img info /data/nvme/ocp4-windows.qcow2
# image: /data/nvme/ocp4-windows.qcow2
# file format: qcow2
# virtual size: 50 GiB (53687091200 bytes)
# disk size: 43.3 GiB
# cluster_size: 65536
# Format specific information:
#     compat: 1.1
#     lazy refcounts: true
#     refcount bits: 16
#     corrupt: false

qemu-img resize /data/nvme/ocp4-windows.qcow2 +20G
# Image resized.


</code></pre>
<h1 id="windows-workload"><a class="header" href="#windows-workload">windows workload</a></h1>
<p>似乎现在的 docker for windows 并不支持给 mcr.microsoft.com 做镜像代理，只能配置一个proxy，这个太讨厌了，等以后迁移到 podman 或者 containerd 吧。所以我们现在基本上属于联网或者半联网的部署模式。</p>
<p><a href="https://hub.docker.com/_/microsoft-windows-base-os-images">在这里查找windows镜像的版本</a>。</p>
<pre><code class="language-bash"># pod pause的镜像
# mcr.microsoft.com/oss/kubernetes/pause:3.4.1

# 创建runtime class
cat &lt;&lt; EOF &gt; /data/install/win-runtime.yaml
apiVersion: node.k8s.io/v1beta1
kind: RuntimeClass
metadata:
  name: runtime-class-win10
handler: 'docker'
scheduling:
  nodeSelector: 
    kubernetes.io/os: 'windows'
    kubernetes.io/arch: 'amd64'
    node.kubernetes.io/windows-build: '10.0.19042'
  tolerations: 
  - effect: NoSchedule
    key: os
    operator: Equal
    value: &quot;Windows&quot;
EOF
oc create -f /data/install/win-runtime.yaml

# https://hub.docker.com/_/microsoft-windows
# mcr.microsoft.com/windows:20H2
cat &lt;&lt; 'EOF' &gt; /data/install/win-dep.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: win-webserver
  name: win-webserver
spec:
  selector:
    matchLabels:
      app: win-webserver
  replicas: 1
  template:
    metadata:
      labels:
        app: win-webserver
      name: win-webserver
    spec:
      tolerations:
      - key: &quot;os&quot;
        value: &quot;Windows&quot;
        Effect: &quot;NoSchedule&quot;
      containers:
      - name: windowswebserver
        image: mcr.microsoft.com/windows:20H2
        imagePullPolicy: IfNotPresent
        command:
        - powershell.exe
        - -command
        - $listener = New-Object System.Net.HttpListener; $listener.Prefixes.Add('http://*:80/'); $listener.Start();Write-Host('Listening at http://*:80/'); while ($listener.IsListening) { $context = $listener.GetContext(); $response = $context.Response; $content='&lt;html&gt;&lt;body&gt;&lt;H1&gt;Red Hat OpenShift + Windows Container Workloads&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;'; $buffer = [System.Text.Encoding]::UTF8.GetBytes($content); $response.ContentLength64 = $buffer.Length; $response.OutputStream.Write($buffer, 0, $buffer.Length); $response.Close(); };
        securityContext:
          windowsOptions:
            runAsUserName: &quot;ContainerAdministrator&quot;
      nodeSelector:
        beta.kubernetes.io/os: windows
EOF
oc create -f /data/install/win-dep.yaml

# to restore
oc delete -f /data/install/win-dep.yaml

cat &lt;&lt; EOF &gt; /data/install/win-svc.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: win-webserver
  labels:
    app: win-webserver
spec:
  ports:
    # the port that this service should serve on
  - port: 80
    targetPort: 80
  selector:
    app: win-webserver
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: win-webserver
spec:
  port:
    targetPort: 80
  to:
    kind: Service
    name: win-webserver
---
EOF
oc create -f /data/install/win-svc.yaml

# try windows server core, if you run on windows server
# otherwize, it will failed, say os not match with host: 
# &quot;The container operating system does not match the host operating system.&quot;
# https://hub.docker.com/_/microsoft-windows-servercore
# mcr.microsoft.com/windows/servercore:20H2

cat &lt;&lt; EOF &gt; /data/install/test-pod.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mypod
  labels:
    app: mypod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mypod
  template:
    metadata:
      labels:
        app: mypod
    spec:
      containers:
      - name: mypod
        image: quay.io/wangzheng422/qimgs:centos7-test
        command:
          - sleep
          - infinity
EOF
oc create -f /data/install/test-pod.yaml

oc get all
# NAME                                READY   STATUS    RESTARTS   AGE
# pod/mypod-6b8b7b46cb-rrfmd          1/1     Running   1          21h
# pod/win-webserver-9f98c76d4-8nb2q   1/1     Running   0          110s

# NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP                            PORT(S)   AGE
# service/kubernetes      ClusterIP      172.30.0.1      &lt;none&gt;                                 443/TCP   26h
# service/openshift       ExternalName   &lt;none&gt;          kubernetes.default.svc.cluster.local   &lt;none&gt;    25h
# service/win-webserver   ClusterIP      172.30.240.75   &lt;none&gt;                                 80/TCP    21h

# NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
# deployment.apps/mypod           1/1     1            1           21h
# deployment.apps/win-webserver   1/1     1            1           110s

# NAME                                      DESIRED   CURRENT   READY   AGE
# replicaset.apps/mypod-6b8b7b46cb          1         1         1       21h
# replicaset.apps/win-webserver-9f98c76d4   1         1         1       110s

# NAME                                     HOST/PORT                                    PATH   SERVICES        PORT   TERMINATION   WILDCARD
# route.route.openshift.io/win-webserver   win-webserver-default.apps.ocp4.redhat.ren          win-webserver   80                   None

curl win-webserver-default.apps.ocp4.redhat.ren &amp;&amp; echo
# &lt;html&gt;&lt;body&gt;&lt;H1&gt;Red Hat OpenShift + Windows Container Workloads&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;

</code></pre>
<pre><code class="language-cmd">oc exec -it pod/win-webserver-9f98c76d4-8nb2q -- cmd

Microsoft Windows [Version 10.0.19042.1237]
(c) Microsoft Corporation. All rights reserved.

C:\&gt;tasklist

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
System Idle Process              0                            0          8 K
System                           4                            0        148 K
smss.exe                      9992                            0      1,760 K
csrss.exe                     6788 Services                   3      4,524 K
wininit.exe                   7096 Services                   3      5,260 K
services.exe                  6456 Services                   3      6,668 K
lsass.exe                     3324 Services                   3     12,536 K
fontdrvhost.exe               5736 Services                   3      2,860 K
svchost.exe                   4948 Services                   3     12,896 K
svchost.exe                   6960 Services                   3      8,180 K
svchost.exe                   3332 Services                   3     16,952 K
svchost.exe                    756 Services                   3     53,864 K
svchost.exe                   5924 Services                   3      9,728 K
svchost.exe                   6412 Services                   3      8,012 K
svchost.exe                   5628 Services                   3      6,740 K
svchost.exe                   9488 Services                   3      4,688 K
svchost.exe                   8912 Services                   3     12,896 K
CExecSvc.exe                  5616 Services                   3      4,020 K
svchost.exe                   5916 Services                   3     28,600 K
svchost.exe                   2780 Services                   3      4,404 K
powershell.exe                2816 Services                   3     78,156 K
CompatTelRunner.exe           3056 Services                   3      2,852 K
svchost.exe                   9412 Services                   3     11,104 K
conhost.exe                   7748 Services                   3     10,824 K
svchost.exe                   3636 Services                   3      7,404 K
conhost.exe                   1288 Services                   3      3,800 K
cmd.exe                       5112 Services                   3      2,884 K
svchost.exe                   4492 Services                   3      8,900 K
MicrosoftEdgeUpdate.exe       8808 Services                   3      1,760 K
svchost.exe                   7612 Services                   3     10,112 K
conhost.exe                   4944 Services                   3      5,176 K
cmd.exe                       9848 Services                   3      5,140 K
MoUsoCoreWorker.exe           3016 Services                   3     17,220 K
WmiPrvSE.exe                  7924 Services                   3      9,340 K
WmiPrvSE.exe                  5976 Services                   3      9,384 K
spoolsv.exe                   6204 Services                   3      6,580 K
conhost.exe                   6184 Services                   3      5,208 K
cmd.exe                       5680 Services                   3      4,428 K
tasklist.exe                  8424 Services                   3      8,812 K
</code></pre>
<p>在win10上，我们能从docker界面上，看到有2个container启动了。
<img src="imgs/2021-10-08-17-18-09.png" alt="" /></p>
<p>同样，在docker界面上，我们能看到他下载了2个镜像，并且正在使用中。
<img src="imgs/2021-10-08-17-19-05.png" alt="" /></p>
<h1 id="排错"><a class="header" href="#排错">排错</a></h1>
<p>如果发现有异常，首先要做的是，查看kubelet, kubeproxy, hybrid-overlay-node 这3个服务，是不是还在运行，当前的版本，似乎这几个服务，很容易崩溃。</p>
<p>之后，就是看看默认网卡的ipv4配置，是否被禁用了，估计未来兼容性好了，就不用操心这个了。</p>
<!-- if anything wrong, first, check kubelet, kubeproxy, hybrid-overlay-node services on windows node, those services are easy to crash right now.

Then go to check nic ipv4 config, by default, it will change to dhcp, but in our static-ip deployment, it should change to some static ip config. -->
<pre><code class="language-bash"># on windows cmd
netsh interface dump

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ocp4/4.8/4.8.update.service.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../ocp4/4.9/4.9.sno.using.bootstrap.disconnected.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ocp4/4.8/4.8.update.service.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../ocp4/4.9/4.9.sno.using.bootstrap.disconnected.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
