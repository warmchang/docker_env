<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ACM zero touch provision 远程单节点集群 全自动安装 - OpenShift4 慢慢走</title>
                

        <!-- Custom HTML head -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E3FRMDB7L2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E3FRMDB7L2');
</script>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">介绍</a></li><li class="chapter-item expanded "><a href="../../install.html"><strong aria-hidden="true">1.</strong> openshift4 安装系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.pull.secret.html"><strong aria-hidden="true">1.1.</strong> 如何获得 openshift4 免费下载密钥</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.build.dist.html"><strong aria-hidden="true">1.2.</strong> openshift4 离线安装介质的制作</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.static.ip.local.assisted.connected.html"><strong aria-hidden="true">1.3.</strong> assisted install 联线模式下 单节点ocp 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.static.ip.local.assisted.disconnected.html"><strong aria-hidden="true">1.4.</strong> assisted install 离线模式下 单节点ocp 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.upi.static.ip.on.rhel7.html"><strong aria-hidden="true">1.5.</strong> openshift4 rhel7物理机 baremetal UPI模式 离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.upi.static.ip.on.rhel8.html"><strong aria-hidden="true">1.6.</strong> openshift4 rhel8物理机 baremetal UPI模式 离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.ipi.on.rhel8.html"><strong aria-hidden="true">1.7.</strong> openshift4 物理机 baremetal IPI模式 离线安装 单网络模式</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.disconnect.bm.ipi.on.rhel8.provisionning.network.html"><strong aria-hidden="true">1.8.</strong> openshift4 物理机 baremetal IPI模式 离线安装 双网络模式</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.cilium.html"><strong aria-hidden="true">1.9.</strong> openshift4 尝鲜 cilium CNI</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.nvidia.gpu.disconnected.html"><strong aria-hidden="true">1.10.</strong> nvidia gpu for openshift 4.6 disconnected 英伟达GPU离线安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.add.image.html"><strong aria-hidden="true">1.11.</strong> openshift4 初始安装后 补充镜像</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.is.sample.html"><strong aria-hidden="true">1.12.</strong> openshift4 补充samples operator 需要的 image stream</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.calico.html"><strong aria-hidden="true">1.13.</strong> openshift4 calico 离线部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.2/4.2.upgrade.html"><strong aria-hidden="true">1.14.</strong> openshift4 集群升级</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.shrink.sysroot.html"><strong aria-hidden="true">1.15.</strong> 缩小根分区 / sysroot 的大小</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.update.service.html"><strong aria-hidden="true">1.16.</strong> 部署升级服务 完善离线升级功能</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.windows.node.html"><strong aria-hidden="true">1.17.</strong> 添加 win10 worker 节点</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.sno.using.bootstrap.disconnected.html"><strong aria-hidden="true">1.18.</strong> 单节点ocp 安装 无需dhcp 静态ip部署</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.disconnect.bm.ipi.sno.static.ip.html"><strong aria-hidden="true">1.19.</strong> IPI模式 单节点 离线 单网络模式 安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.acm.ztp.disconnected.auto.html" class="active"><strong aria-hidden="true">1.20.</strong> ACM zero touch provision 远程单节点集群 全自动安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.coreos.boot.html"><strong aria-hidden="true">1.21.</strong> coreos 启动和分区挂载分析</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.installer.html"><strong aria-hidden="true">1.22.</strong> openshift4 单节点 命令行安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.partition.quay.html"><strong aria-hidden="true">1.23.</strong> openshift4 单节点 在第一块硬盘上添加更多分区</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.nfs.lvm.html"><strong aria-hidden="true">1.24.</strong> openshift4 单节点 使用 lvm 和 nfs 在集群内提供存储</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.boot.from.linux.html"><strong aria-hidden="true">1.25.</strong> openshift4 单节点 从centos7/8 开始安装</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.sno.odf.html"><strong aria-hidden="true">1.26.</strong> openshift4 单节点 安装精简版 ODF/ceph</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.replace.coreos.html"><strong aria-hidden="true">1.27.</strong> 定制 rhcos</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.rpm-ostree.install.html"><strong aria-hidden="true">1.28.</strong> rhcos 里面安装 rpm</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.component.version.html"><strong aria-hidden="true">1.29.</strong> openshift 4 组件版本</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.embeded.dns.haproxy.registry.html"><strong aria-hidden="true">1.30.</strong> 内嵌 dns, haproxy, registrty</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.replace.coreos.rhel.9.0.html"><strong aria-hidden="true">1.31.</strong> 升级 openshift 4.10 内核到 rhel 9.1 支持 海光 x86 cpu</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.11/4.11.acm.hypershift.html"><strong aria-hidden="true">1.32.</strong> 使用 hypershift 安装控制面托管的 openshift 集群</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.12/4.12.3node.upi.agent.html"><strong aria-hidden="true">1.33.</strong> 使用 agent based installer 安装 3 节点集群</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.12/4.12.single.node.upi.agent.html"><strong aria-hidden="true">1.34.</strong> 使用 agent based installer 安装 单节点集群</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.12/4.12.ocp.driver.build.html"><strong aria-hidden="true">1.35.</strong> 在 openshift 内部编译内核驱动 rpm 并使用</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.12/4.12.demo.lab.html"><strong aria-hidden="true">1.36.</strong> how to build an openshift 4.12 demo lab from scratch</a></li></ol></li><li class="chapter-item expanded "><a href="../../usage.html"><strong aria-hidden="true">2.</strong> openshift4 使用系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.11/4.11.3node.ipi.for.osp.prod.html"><strong aria-hidden="true">2.1.</strong> 在 openshift 4.11 上安装和运行 openstack</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.flexran.20.11.pf.deploy.html"><strong aria-hidden="true">2.2.</strong> 在openshift4上运行 OpenRAN 无线基站应用</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.netflow.table.html"><strong aria-hidden="true">2.3.</strong> openshift4 可视化 ovs netflow</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.flexran.20.11.html"><strong aria-hidden="true">2.4.</strong> intel o-ran flexran 方案在openshift4上的安装和使用</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.ci.cd.demo.html"><strong aria-hidden="true">2.5.</strong> ci/cd pipeline gitops演示</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.oc.exec.html"><strong aria-hidden="true">2.6.</strong> oc/kubectl exec 原理分析</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.nf.conntrack.html"><strong aria-hidden="true">2.7.</strong> nf_conntrack 在 openshift4.9上的处理</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.load.3rd.part.driver.html"><strong aria-hidden="true">2.8.</strong> 加载第三方设备驱动</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.9/4.9.nep.containerized.helm.html"><strong aria-hidden="true">2.9.</strong> helm chart/helm operator</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.metalb.l2.html"><strong aria-hidden="true">2.10.</strong> 使用 MetalLB 用 Layer2 发布 LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.metalb.html"><strong aria-hidden="true">2.11.</strong> 使用 MetalLB 用 BGP 发布 LoadBalancer</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.8/4.8.kata.html"><strong aria-hidden="true">2.12.</strong> kata / 沙盒容器</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.sriov.html"><strong aria-hidden="true">2.13.</strong> 在非官方支持的网卡上，测试SRIOV/DPDK</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.keepalived.operator.html"><strong aria-hidden="true">2.14.</strong> 使用 keepalived 激活 LoadBalancer 服务类型</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.real-time.kernel.html"><strong aria-hidden="true">2.15.</strong> 在节点上启用实时操作系统 real-time kernel</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.install.kmod.driver.html"><strong aria-hidden="true">2.16.</strong> 从容器向宿主机注入内核模块 kmod / driver</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.vgpu.sharing.deploy.html"><strong aria-hidden="true">2.17.</strong> GPU/vGPU 共享</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.headless.service.html"><strong aria-hidden="true">2.18.</strong> openshift headless service讲解</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.volumn.html"><strong aria-hidden="true">2.19.</strong> openshift volumn 存储的各种测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.SupportPodPidsLimit.html"><strong aria-hidden="true">2.20.</strong> openshift 设置 SupportPodPidsLimit 解除 pids 限制</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.sso.html"><strong aria-hidden="true">2.21.</strong> openshift4 配置 SSO 点单认证</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.scc.html"><strong aria-hidden="true">2.22.</strong> openshift4 SCC 相关安全能力测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.recover.node.not.ready.html"><strong aria-hidden="true">2.23.</strong> openshift4 从 node not ready 状态恢复</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.QoS.nic.html"><strong aria-hidden="true">2.24.</strong> openshift4 QoS 能力</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.QoS.nic.high.html"><strong aria-hidden="true">2.25.</strong> openshift4 QoS 在流量压力下的表现</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.proxy.html"><strong aria-hidden="true">2.26.</strong> openshift4 使用 image proxy 来下载镜像</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.numa.html"><strong aria-hidden="true">2.27.</strong> openshift4 NUMA 绑核测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.network.policy.html"><strong aria-hidden="true">2.28.</strong> openshift4 Network Policy 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.multicast.html"><strong aria-hidden="true">2.29.</strong> openshift4 网络多播 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.firewall.html"><strong aria-hidden="true">2.30.</strong> openshift4 配置节点防火墙</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.ldap.html"><strong aria-hidden="true">2.31.</strong> openshift4 集成 ldap</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.image.pull.html"><strong aria-hidden="true">2.32.</strong> openshift4 维护 image pull secret</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.huge.page.html"><strong aria-hidden="true">2.33.</strong> openshift4 使用大页内存 huge page</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.helm.html"><strong aria-hidden="true">2.34.</strong> openshift4 使用 helm</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.haproxy.html"><strong aria-hidden="true">2.35.</strong> openshift4 定制router 支持 TCP ingress</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.grafana.html"><strong aria-hidden="true">2.36.</strong> openshift4 监控能力展示 grafana</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.cpu.manager.html"><strong aria-hidden="true">2.37.</strong> openshift4 CPU 绑核 测试</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.3/4.3.build.config.html"><strong aria-hidden="true">2.38.</strong> openshift4 build config &amp; hpa 自动化编译和自动扩缩容</a></li></ol></li><li class="chapter-item expanded "><a href="../../ccn.html"><strong aria-hidden="true">3.</strong> 应用上云系列教程 CCN</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ccn.devops.deploy.html"><strong aria-hidden="true">3.1.</strong> 应用上云系列教程 containerized cloud native (CCN) for openshift 4.4</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ccn.devops.build.html"><strong aria-hidden="true">3.2.</strong> CCN 安装介质制作 for openshift 4.4</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.ccn.devops.deploy.html"><strong aria-hidden="true">3.3.</strong> 应用上云系列教程 containerized cloud native (CCN) for openshift 4.6</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.6/4.6.ccn.devops.build.html"><strong aria-hidden="true">3.4.</strong> CCN 安装介质制作 for openshift 4.6</a></li></ol></li><li class="chapter-item expanded "><a href="../../rh.cloud.html"><strong aria-hidden="true">4.</strong> 红帽其他产品系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.10/4.10.acm.observ.html"><strong aria-hidden="true">4.1.</strong> ACM observability for openshift 4.10</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.ansible.install.html"><strong aria-hidden="true">4.2.</strong> 离线安装 ansible platform</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.08.virus.html"><strong aria-hidden="true">4.3.</strong> RHACS 应对log4j 原理和实践</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.ocs.cnv.ceph.html"><strong aria-hidden="true">4.4.</strong> openshift承载虚拟化业务(CNV)</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.rhacs.html"><strong aria-hidden="true">4.5.</strong> RHACS / stackrox</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.7/4.7.rhacs.deep.html"><strong aria-hidden="true">4.6.</strong> 为 RHACS 找个应用场景: 安全合规测试云 </a></li></ol></li><li class="chapter-item expanded "><a href="../../os.html"><strong aria-hidden="true">5.</strong> 操作系统相关</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../notes/2023/satellite.demo.html"><strong aria-hidden="true">5.1.</strong> satellite 红帽注册和内容分发代理</a></li><li class="chapter-item expanded "><a href="../../notes/2023/rhel.subscription.register.html"><strong aria-hidden="true">5.2.</strong> RHEL 订阅在线注册相关问题</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.12.boot.to.install.html"><strong aria-hidden="true">5.3.</strong> 通过新增系统启动项来原地重装操作系统</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.04.os.backup.ReaR.html"><strong aria-hidden="true">5.4.</strong> Relax and Recover(ReaR) 系统备份和灾难恢复</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.04.no-cost.rhel.sub.html"><strong aria-hidden="true">5.5.</strong> 红帽免费的开发者订阅申请和使用</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.rpm.belongs.html"><strong aria-hidden="true">5.6.</strong> 在红帽官网查询rpm属于哪个repo</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.rhel7.upgrade.to.rhel8.html"><strong aria-hidden="true">5.7.</strong> 离线环境下 原地升级 rhel7-&gt;rhel8</a></li><li class="chapter-item expanded "><a href="../../notes/2022/2022.01.sysctl.html"><strong aria-hidden="true">5.8.</strong> 系统启动自动加载sysctl配置</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.12.ocp.bf2.dpi.url.filter.html"><strong aria-hidden="true">5.9.</strong> Mellanox BF2 刷固件并测试DPI URL-filter场景</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.11.bf2.snap.try.html"><strong aria-hidden="true">5.10.</strong> Mellanox BF2 网卡激活snap功能，配置nvme over fabrics 支持</a></li><li class="chapter-item expanded "><a href="../../notes/2021/2021.10.cx6dx.vdpa.offload.html"><strong aria-hidden="true">5.11.</strong> Mellanox CX6 vdpa 硬件卸载 ovs-kernel 方式</a></li><li class="chapter-item expanded "><a href="../../rhel/rhel.build.kernel.html"><strong aria-hidden="true">5.12.</strong> RHEL8编译定制化内核</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.check.whether.vm.html"><strong aria-hidden="true">5.13.</strong> 检查OS是否是运行在虚拟机上</a></li><li class="chapter-item expanded "><a href="../../ocp4/4.4/4.4.ovs.html"><strong aria-hidden="true">5.14.</strong> 两个主机用ovs组网</a></li></ol></li><li class="chapter-item expanded "><a href="../../workshop.html"><strong aria-hidden="true">6.</strong> 优秀的workshop</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.5/4.5.ocp.ocs.workshop.html"><strong aria-hidden="true">6.1.</strong> openshift4 &amp; openshift storage workshop</a></li></ol></li><li class="chapter-item expanded "><a href="../../poc.html"><strong aria-hidden="true">7.</strong> POC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../ocp4/4.3/poc.sc/install.poc.sc.html"><strong aria-hidden="true">7.1.</strong> 2020.04 某次POC openshift LVM调优</a></li></ol></li><li class="chapter-item expanded "><a href="../../osx.html"><strong aria-hidden="true">8.</strong> OSX使用技巧</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../osx/osx.record.system.audio.html"><strong aria-hidden="true">8.1.</strong> 如何录制系统声音</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">OpenShift4 慢慢走</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/wangzheng422/docker_env" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/wangzheng422/docker_env/blob/dev/redhat/ocp4/4.10/4.10.acm.ztp.disconnected.auto.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="openshift410-acm-with-ztp-disconnected-static-ip-auto"><a class="header" href="#openshift410-acm-with-ztp-disconnected-static-ip-auto">openshift4.10 acm with ztp disconnected static-ip auto</a></h1>
<p>本文介绍，在openshift4.10上，装ACM组件以后，如何通过zero touch provision的方式，来部署一个单节点openshift4.10的集群（SNO），在部署的过程中，我们模拟离线的网络环境，并且禁止DHCP，只用静态IP。</p>
<p>ZTP(zero touch provision)模式之所以诱人，是因为他只需要baremetal的bmc信息，以及网卡的mac地址，就可以完成集群的部署。ACM会创建一个iso，并调用bmc的api，去挂载这个iso并启动。</p>
<p>本次实验，使用一个半自动流程，就是让ACM创建iso，但是手动用iso启动kvm。整个流程如下：</p>
<ol>
<li>在openshift4上安装ACM组件</li>
<li>在ACM上配置cluster, infra env等配置。</li>
<li>ACM通过网络启动kvm</li>
<li>kvm自动开始集群安装，但是由于kvm+redfish的限制，需要手动配置之后的重启都是由硬盘启动。</li>
<li>集群安装完成，保存集群登录信息</li>
</ol>
<p>本次实验的部署架构图：</p>
<p><img src="./dia/4.10.bm.ipi.sno.static.ip.drawio.svg" alt="" /></p>
<p>本次实验有一个前导实验，就是用一个单机版本的assisted install service部署一个SNO集群，这个SNO集群是本次实验部署ACM的基础。这个前导实验如何做，请<a href="../4.9/4.9.sno.static.ip.local.assisted.disconnected.mini.iso.html">参见这里</a>。</p>
<p>参考资料：</p>
<ul>
<li>https://github.com/jparrill/ztp-the-hard-way/blob/main/docs/connected-ZTP-flow-hub-deployment.md</li>
<li>https://github.com/jparrill/ztp-the-hard-way/blob/main/docs/disconnected-ZTP-flow-hub-deployment.md</li>
</ul>
<p>视频讲解</p>
<p><a href="https://www.bilibili.com/video/bv1F3411n7tT"><kbd><img src="imgs/20220412112651.png" width="600"></kbd></a></p>
<ul>
<li><a href="https://www.bilibili.com/video/bv1F3411n7tT">bilibili</a></li>
<li><a href="https://youtu.be/tX2iozE2Rn0">youtube</a></li>
</ul>
<h1 id="静态变量和-kvm-配置"><a class="header" href="#静态变量和-kvm-配置">静态变量和 kvm 配置</a></h1>
<p>assisted install 模式下，如果想静态ip安装，需要在实验网络上部署一个dns服务。因为我们部署的是single node openshift，只需要把如下4个域名，指向同一个ip地址就可以。当然，你需要提前想好域名。同时，我们的实验环境里面，其实有2个SNO，所以要配置2套域名。</p>
<ul>
<li>acm-demo-hub.redhat.ren
<ul>
<li>api.acm-demo-hub.redhat.ren</li>
<li>api-int.acm-demo-hub.redhat.ren</li>
<li>*.apps.acm-demo-hub.redhat.ren</li>
<li>acm-demo-hub-master.acm-demo-hub.redhat.ren</li>
</ul>
</li>
<li>acm-demo1.redhat.ren
<ul>
<li>api.acm-demo1.redhat.ren</li>
<li>api-int.acm-demo1.redhat.ren</li>
<li>*.apps.acm-demo1.redhat.ren</li>
<li>acm-demo1-master.acm-demo1.redhat.ren</li>
</ul>
</li>
</ul>
<p>我们复用本作者基于上游改的一套ansible脚本来配置这个dns</p>
<pre><code class="language-bash"># on helper

# 做一些配置参数定义
INSTALL_IMAGE_REGISTRY=quaylab.infra.redhat.ren
PULL_SECRET='{&quot;auths&quot;:{&quot;registry.redhat.io&quot;: {&quot;auth&quot;: &quot;ZHVtbXk6ZHVtbXk=&quot;,&quot;email&quot;: &quot;noemail@localhost&quot;},&quot;registry.ocp4.redhat.ren:5443&quot;: {&quot;auth&quot;: &quot;ZHVtbXk6ZHVtbXk=&quot;,&quot;email&quot;: &quot;noemail@localhost&quot;},&quot;'${INSTALL_IMAGE_REGISTRY}'&quot;: {&quot;auth&quot;: &quot;'$( echo -n 'quayadmin:password' | openssl base64 )'&quot;,&quot;email&quot;: &quot;noemail@localhost&quot;}}}'

ACM_DEMO_CLUSTER=acm-demo1

SNO_BASE_DOMAIN=redhat.ren
SNO_IP=192.168.7.15
SNO_GW=192.168.7.1
SNO_NETMAST=255.255.255.0
SNO_NETMAST_S=24
SNO_HOSTNAME=acm-demo1-master
SNO_IF=enp1s0
SNO_IF_MAC=`printf '00:60:2F:%02X:%02X:%02X' $[RANDOM%256] $[RANDOM%256] $[RANDOM%256]`
SNO_DNS=192.168.7.11
SNO_DISK=/dev/vda
SNO_CORE_PWD=redhat

echo ${SNO_IF_MAC} &gt; /data/install/acm.demo1.mac

# back to kvm host

create_lv() {
    var_vg=$1
    var_lv=$2
    var_size=$3
    lvremove -f $var_vg/$var_lv
    lvcreate -y -L $var_size -n $var_lv $var_vg
    wipefs --all --force /dev/$var_vg/$var_lv
}

create_lv vgdata lvacmdemo1 120G

export KVM_DIRECTORY=/data/kvm

mkdir -p  ${KVM_DIRECTORY}
cd ${KVM_DIRECTORY}
scp root@192.168.7.11:/data/install/acm.demo1.mac ${KVM_DIRECTORY}/

# on kvm host
# export KVM_DIRECTORY=/data/kvm
virt-install --name=ocp4-acm-demo1-master0 --vcpus=16 --ram=32768 \
--cpu=host-model \
--disk path=/dev/vgdata/lvacmdemo1,device=disk,bus=virtio,format=raw \
--disk device=cdrom \
--os-variant rhel8.3 --network bridge=baremetal,model=virtio,mac=$(&lt;acm.demo1.mac) \
--graphics vnc,port=59013 \
--boot uefi,nvram_template=/usr/share/OVMF/OVMF_VARS.fd,menu=on \
--print-xml &gt; ${KVM_DIRECTORY}/ocp4-acm-demo1.xml
virsh define --file ${KVM_DIRECTORY}/ocp4-acm-demo1.xml


cd /data/kvm/
# for i in master{0..2} worker{0..2}
for i in acm-demo1-master{0..0}
do
  echo -ne &quot;${i}\t&quot; ; 
  virsh dumpxml ocp4-${i} | grep &quot;mac address&quot; | cut -d\' -f2 | tr '\n' '\t'
  echo 
done &gt; mac.list
cat /data/kvm/mac.list
# acm-demo1-master0       00:60:2f:ee:aa:4e

scp /data/kvm/mac.list root@192.168.7.11:/data/install/

</code></pre>
<h1 id="dns-配置"><a class="header" href="#dns-配置">DNS 配置</a></h1>
<pre><code class="language-bash"># back to helper

# set up dns
cd /data/ocp4/ocp4-upi-helpernode-master/
cat &lt;&lt; 'EOF' &gt; /data/ocp4/ocp4-upi-helpernode-master/vars.yaml
---
ocp_version: 4.10.4
ssh_gen_key: false
staticips: true
bm_ipi: true
firewalld: false
dns_forward: true
iso:
  iso_dl_url: &quot;file:///data/ocp4/rhcos-live.x86_64.iso&quot;
  my_iso: &quot;rhcos-live.iso&quot;
helper:
  name: &quot;helper&quot;
  ipaddr: &quot;192.168.7.11&quot;
  networkifacename: &quot;enp1s0&quot;
  gateway: &quot;192.168.7.1&quot;
  netmask: &quot;255.255.255.0&quot;
dns:
  domain: &quot;redhat.ren&quot;
  clusterid: &quot;ocp4&quot;
  forwarder1: &quot;172.21.1.1&quot;
  forwarder2: &quot;172.21.1.1&quot;
  api_vip: &quot;192.168.7.100&quot;
  ingress_vip: &quot;192.168.7.101&quot;
bootstrap:
  name: &quot;bootstrap&quot;
  ipaddr: &quot;192.168.7.12&quot;
  interface: &quot;enp1s0&quot;
  install_drive: &quot;vda&quot;
  # macaddr: &quot;52:54:00:7e:f8:f7&quot;
masters:
  - name: &quot;master-0&quot;
    ipaddr: &quot;192.168.7.13&quot;
    interface: &quot;enp1s0&quot;
    install_drive: &quot;vda&quot;
    # macaddr: &quot;$(cat /data/install/mac.list | grep master0 | awk '{print $2}')&quot;
#   - name: &quot;master-1&quot;
#     ipaddr: &quot;192.168.7.14&quot;
#     interface: &quot;enp1s0&quot;
#     install_drive: &quot;vda&quot;    
#     macaddr: &quot;$(cat /data/install/mac.list | grep master1 | awk '{print $2}')&quot;
#   - name: &quot;master-2&quot;
#     ipaddr: &quot;192.168.7.15&quot;
#     interface: &quot;enp1s0&quot;
#     install_drive: &quot;vda&quot;   
#     macaddr: &quot;$(cat /data/install/mac.list | grep master2 | awk '{print $2}')&quot;
# workers:
#   - name: &quot;worker-0&quot;
#     ipaddr: &quot;192.168.7.16&quot;
#     interface: &quot;enp1s0&quot;
#     install_drive: &quot;vda&quot;
#     macaddr: &quot;$(cat /data/install/mac.list | grep worker0 | awk '{print $2}')&quot;
#   - name: &quot;worker-1&quot;
#     ipaddr: &quot;192.168.7.17&quot;
#     interface: &quot;enp1s0&quot;
#     install_drive: &quot;vda&quot;
#     macaddr: &quot;$(cat /data/install/mac.list | grep worker1 | awk '{print $2}')&quot;
#   - name: &quot;worker-2&quot;
#     ipaddr: &quot;192.168.7.18&quot;
#     interface: &quot;enp1s0&quot;
#     install_drive: &quot;vda&quot;
#     macaddr: &quot;$(cat /data/install/mac.list | grep worker2 | awk '{print $2}')&quot;
others:
  - name: &quot;registry&quot;
    ipaddr: &quot;192.168.7.103&quot;
  - name: &quot;yum&quot;
    ipaddr: &quot;172.21.6.103&quot;
  - name: &quot;quay&quot;
    ipaddr: &quot;172.21.6.103&quot;
  - name: &quot;nexus&quot;
    ipaddr: &quot;172.21.6.103&quot;
  - name: &quot;git&quot;
    ipaddr: &quot;172.21.6.103&quot;
otherdomains:
  - domain: &quot;infra.redhat.ren&quot;
    hosts:
    - name: &quot;registry&quot;
      ipaddr: &quot;192.168.7.1&quot;
    - name: &quot;yum&quot;
      ipaddr: &quot;192.168.7.1&quot;
    - name: &quot;quay&quot;
      ipaddr: &quot;192.168.7.1&quot;
    - name: &quot;quaylab&quot;
      ipaddr: &quot;192.168.7.1&quot;
    - name: &quot;nexus&quot;
      ipaddr: &quot;192.168.7.1&quot;
    - name: &quot;git&quot;
      ipaddr: &quot;192.168.7.1&quot;
  - domain: &quot;acm-demo1.redhat.ren&quot;
    hosts:
    - name: &quot;api&quot;
      ipaddr: &quot;192.168.7.15&quot;
    - name: &quot;api-int&quot;
      ipaddr: &quot;192.168.7.15&quot;
    - name: &quot;acm-demo1-master&quot;
      ipaddr: &quot;192.168.7.15&quot;
    - name: &quot;*.apps&quot;
      ipaddr: &quot;192.168.7.15&quot;
  - domain: &quot;acm-demo-hub.redhat.ren&quot;
    hosts:
    - name: &quot;api&quot;
      ipaddr: &quot;192.168.7.13&quot;
    - name: &quot;api-int&quot;
      ipaddr: &quot;192.168.7.13&quot;
    - name: &quot;acm-demo-hub-master&quot;
      ipaddr: &quot;192.168.7.13&quot;
    - name: &quot;*.apps&quot;
      ipaddr: &quot;192.168.7.13&quot;
force_ocp_download: false
remove_old_config_files: false
ocp_client: &quot;file:///data/ocp4/{{ ocp_version }}/openshift-client-linux-{{ ocp_version }}.tar.gz&quot;
ocp_installer: &quot;file:///data/ocp4/{{ ocp_version }}/openshift-install-linux-{{ ocp_version }}.tar.gz&quot;
ppc64le: false
arch: 'x86_64'
chronyconfig:
  enabled: true
  content:
    - server: &quot;192.168.7.11&quot;
      options: iburst
setup_registry: # don't worry about this, just leave it here
  deploy: false
  registry_image: docker.io/library/registry:2
  local_repo: &quot;ocp4/openshift4&quot;
  product_repo: &quot;openshift-release-dev&quot;
  release_name: &quot;ocp-release&quot;
  release_tag: &quot;4.6.1-x86_64&quot;
ocp_filetranspiler: &quot;file:///data/ocp4/filetranspiler.tgz&quot;
registry_server: &quot;registry.ocp4.redhat.ren:5443&quot;
EOF

ansible-playbook -e @vars.yaml tasks/main.yml

# then followin AIS, to install sno using 192.168.7.13
</code></pre>
<h1 id="部署cnv"><a class="header" href="#部署cnv">部署CNV</a></h1>
<p>我们部署ACM，是需要存储的，最简单的存储，就是本地目录啦，那我们就需要一个自动的auto provisioner，正好CNV带有一个hostpath auto provisioner，所以作者就犯懒，部署一个CNV，为的是里面的本地目录的自动部署。</p>
<pre><code class="language-bash"># 首先需要一个本地目录
cat &lt;&lt; EOF &gt; /data/install/host-path.yaml
---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: 50-set-selinux-for-hostpath-master
  labels:
    machineconfiguration.openshift.io/role: master
spec:
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Set SELinux chcon for hostpath baicell
            Before=kubelet.service

            [Service]
            Type=oneshot
            RemainAfterExit=yes
            ExecStartPre=-mkdir -p /var/hostpath
            ExecStart=chcon -Rt container_file_t /var/hostpath/

            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: hostpath-baicell.service
EOF
oc create -f /data/install/host-path.yaml

# install operator OpenShift Virtualization
# active HostPathProvisioner deployment

# https://docs.openshift.com/container-platform/4.9/virt/install/installing-virt-cli.html

cat &lt;&lt; EOF &gt; /data/install/cnv.subscript.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-cnv
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: kubevirt-hyperconverged-group
  namespace: openshift-cnv
spec:
  targetNamespaces:
    - openshift-cnv
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: hco-operatorhub
  namespace: openshift-cnv
spec:
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  name: kubevirt-hyperconverged
  # startingCSV: kubevirt-hyperconverged-operator.v4.9.3
  channel: &quot;stable&quot; 
EOF
oc create -f /data/install/cnv.subscript.yaml

# 创建hostpath配置
cat &lt;&lt; EOF &gt; /data/install/host-path-provision.yaml
apiVersion: hostpathprovisioner.kubevirt.io/v1beta1
kind: HostPathProvisioner
metadata:
  name: hostpath-provisioner
spec:
  imagePullPolicy: IfNotPresent
  pathConfig:
    path: &quot;/var/hostpath&quot; 
    useNamingPrefix: false 

EOF
oc create -f /data/install/host-path-provision.yaml -n openshift-cnv

# 创建storage class配置
cat &lt;&lt; EOF &gt; /data/install/host-path-storage-class.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: hostpath-provisioner 
  annotations:
    storageclass.kubernetes.io/is-default-class: 'true'
provisioner: kubevirt.io/hostpath-provisioner
reclaimPolicy: Delete 
volumeBindingMode: WaitForFirstConsumer 
EOF
oc create -f /data/install/host-path-storage-class.yaml

</code></pre>
<p>部署完了这样：</p>
<p><img src="../4.9/imgs/2022-03-14-11-10-25.png" alt="" /></p>
<h1 id="部署acm"><a class="header" href="#部署acm">部署ACM</a></h1>
<p>接下来，我们就部署ACM，我们用最简单的部署模式。</p>
<pre><code class="language-bash"># install operator Advanced Cluster Management for Kubernetes

# https://docs.openshift.com/container-platform/4.9/scalability_and_performance/ztp-deploying-disconnected.html#enabling-assisted-installer-service-on-bare-metal_ztp-deploying-disconnected
# https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.4/html/install/installing#installing-from-the-cli


cat &lt;&lt; EOF &gt; /data/install/acm.subscript.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: open-cluster-management
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name:  open-cluster-management-wzh
  namespace: open-cluster-management
spec:
  targetNamespaces:
    - open-cluster-management
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: advanced-cluster-management
  namespace: open-cluster-management
spec:
  sourceNamespace: openshift-marketplace
  source: redhat-operators
  channel: release-2.4
  installPlanApproval: Automatic
  name: advanced-cluster-management
  # startingCSV: advanced-cluster-management.v2.4.2
EOF
oc create -f /data/install/acm.subscript.yaml

# RHACM create the MultiClusterHub resource

cat &lt;&lt; EOF &gt; /data/install/acm.mch.mch.yaml
apiVersion: operator.open-cluster-management.io/v1
kind: MultiClusterHub
metadata:
  name: multiclusterhub
  namespace: open-cluster-management
spec: {}
EOF
oc create -f /data/install/acm.mch.mch.yaml

</code></pre>
<p>装好了是这样：</p>
<p><img src="../4.9/imgs/2022-03-14-11-44-44.png" alt="" /></p>
<p>我们可以通过webUI访问ACM： https://multicloud-console.apps.acm-demo-hub.redhat.ren/overview</p>
<p><img src="../4.9/imgs/2022-03-14-11-47-11.png" alt="" /></p>
<p>我们可以看到有一个local clustr，这个就是ACM自己运行的集群：</p>
<p><img src="../4.9/imgs/2022-03-14-11-51-38.png" alt="" /></p>
<h1 id="用ztp模式部署一个sno"><a class="header" href="#用ztp模式部署一个sno">用ZTP模式部署一个SNO</a></h1>
<p>有过部署assisted install service，并通过AIS来部署SNO的经验，那么通过ACM，用ZTP的模式来部署，就容易理解了，整个过程一样，都是配置ACM里面的assisted install service，然后创建一个iso出来，调用BMC API，来直接挂载iso，并启动主机。</p>
<h2 id="命令行配置新集群"><a class="header" href="#命令行配置新集群">命令行配置新集群</a></h2>
<p>ACM 2.4 UI 上并不是完全支持ZTP，所以有些配置要用命令行完成，后续版本会把UI补上。</p>
<pre><code class="language-bash"># https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.4/html-single/clusters/index#infra-env-prerequisites
oc project open-cluster-management

# do not need, because now, it is acm 2.4.2
# but it seems doesn't matter, if you enable it
oc patch hiveconfig hive --type merge -p '{&quot;spec&quot;:{&quot;targetNamespace&quot;:&quot;hive&quot;,&quot;logLevel&quot;:&quot;debug&quot;,&quot;featureGates&quot;:{&quot;custom&quot;:{&quot;enabled&quot;:[&quot;AlphaAgentInstallStrategy&quot;]},&quot;featureSet&quot;:&quot;Custom&quot;}}}'

oc get hiveconfig hive -o yaml
# ......
# spec:
#   featureGates:
#     custom:
#       enabled:
#       - AlphaAgentInstallStrategy
#     featureSet: Custom
#   logLevel: debug
#   targetNamespace: hive
# ......

oc patch provisioning provisioning-configuration --type merge -p '{&quot;spec&quot;:{&quot;watchAllNamespaces&quot;: true }}'

oc get provisioning provisioning-configuration -o yaml
# ......
# spec:
#   preProvisioningOSDownloadURLs: {}
#   provisioningIP: 192.168.7.103
#   provisioningMacAddresses:
#   - 00:60:2f:ab:66:f6
#   provisioningNetwork: Disabled
#   provisioningNetworkCIDR: 192.168.7.0/24
#   provisioningOSDownloadURL: http://192.168.7.11:8080/install/rhcos-openstack.x86_64.qcow2.gz?sha256=6b5731d90fa78eb50c07928811675d$f9c1d3f94eca0a94afef17cfbce706ddf
#   watchAllNamespaces: true
# ......

cat &lt;&lt; EOF &gt; /data/install/acm.ocp.release.yaml
apiVersion: hive.openshift.io/v1
kind: ClusterImageSet
metadata:
  name: openshift-v4.10.4
  namespace: open-cluster-management
spec:
  releaseImage: ${INSTALL_IMAGE_REGISTRY}/ocp4/openshift4:4.10.4-x86_64
EOF
oc create -f /data/install/acm.ocp.release.yaml

oc get ClusterImageSet
# NAME                RELEASE
# openshift-v4.10.4   quaylab.infra.redhat.ren/ocp4/openshift4:4.10.4-x86_64

cat &lt;&lt; EOF &gt; /data/install/acm.cm.asc.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: assisted-service-config
  namespace: open-cluster-management
  labels:
    app: assisted-service
data:
  LOG_LEVEL: &quot;debug&quot;
EOF
oc create -f /data/install/acm.cm.asc.yaml


cat &lt;&lt; EOF &gt; /data/install/acm.secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: assisted-deployment-pull-secret
  namespace: open-cluster-management
stringData:
  .dockerconfigjson: '$PULL_SECRET'
EOF
oc create -f /data/install/acm.secret.yaml

# oc get pod -A | grep metal3
# the result is empty, so we will go in manual way
oc get pod -A | grep metal3
# openshift-machine-api                              metal3-697fb46867-8zxxw                                           7/7     Running     8 (42m ago)    4h40m
# openshift-machine-api                              metal3-image-cache-hhvnm                                          1/1     Running     1              4h40m
# openshift-machine-api                              metal3-image-customization-577f886bb4-cwl2l                       1/1     Running     1              4h40m

# curl -s https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.9.12/release.txt | grep 'machine-os '
cat /data/ocp4/4.10.4/release.txt | grep 'machine-os '
  # machine-os 410.84.202203081640-0 Red Hat Enterprise Linux CoreOS

cat &lt;&lt; EOF &gt; /data/install/acm.mirror.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyper1-mirror-config
  namespace: open-cluster-management
  labels:
    app: assisted-service
data:
  ca-bundle.crt: |
$( cat /etc/crts/redhat.ren.ca.crt | sed 's/^/    /g' )
  registries.conf: |
    unqualified-search-registries = [&quot;registry.access.redhat.com&quot;, &quot;docker.io&quot;]

    [[registry]]
      prefix = &quot;&quot;
      location = &quot;quay.io/openshift-release-dev/ocp-release&quot;
      mirror-by-digest-only = true

      [[registry.mirror]]
        location = &quot;${INSTALL_IMAGE_REGISTRY}/ocp4/openshift4&quot;

    [[registry]]
      prefix = &quot;&quot;
      location = &quot;quay.io/openshift-release-dev/ocp-v4.0-art-dev&quot;
      mirror-by-digest-only = true

      [[registry.mirror]]
        location = &quot;${INSTALL_IMAGE_REGISTRY}/ocp4/openshift4&quot;

---
EOF
oc create -f /data/install/acm.mirror.yaml


cat &lt;&lt; EOF &gt; /data/install/acm.agentservicecofnig.yaml
apiVersion: agent-install.openshift.io/v1beta1
kind: AgentServiceConfig
metadata:
  name: agent
  namespace: open-cluster-management
  ### This is the annotation that injects modifications in the Assisted Service pod
  annotations:
    unsupported.agent-install.openshift.io/assisted-service-configmap: &quot;assisted-service-config&quot;
###
spec:
  databaseStorage:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 40Gi
  filesystemStorage:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 40Gi
  ### This is a ConfigMap that only will make sense on Disconnected environments
  mirrorRegistryRef:
    name: &quot;hyper1-mirror-config&quot;
  ###
  osImages:
    - openshiftVersion: &quot;4.10&quot;
      version: &quot;410.84.202203081640-0&quot;
      url: &quot;http://192.168.7.11:8080/install/live.iso&quot;
      rootFSUrl: &quot;http://192.168.7.11:8080/install/rootfs.img.4.9&quot;
      cpuArchitecture: x86_64
EOF
oc create -f /data/install/acm.agentservicecofnig.yaml
# oc delete -f /data/install/acm.asc.yaml

oc get AgentServiceConfig/agent -n open-cluster-management -o yaml  
# ......
# status:
#   conditions:
#   - lastTransitionTime: &quot;2022-04-06T09:38:21Z&quot;
#     message: AgentServiceConfig reconcile completed without error.
#     reason: ReconcileSucceeded
#     status: &quot;True&quot;
#     type: ReconcileCompleted

# logs in infrastructure-operator 

# stop here, and wait the assisted-service pod run into ok status
oc get pod -n open-cluster-management | grep assisted
# assisted-image-service-b686cf67d-4hs2t                            1/1     Running   0                44s
# assisted-service-7476bfdd8c-lnnn8                                 2/2     Running   0                44s

# begin to create new cluster

oc create ns ${ACM_DEMO_CLUSTER}
oc project ${ACM_DEMO_CLUSTER}

cat &lt;&lt; EOF &gt; /data/install/acm.managed.secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: assisted-deployment-pull-secret
  namespace: ${ACM_DEMO_CLUSTER}
stringData:
  .dockerconfigjson: '$PULL_SECRET'
EOF
oc create -f /data/install/acm.managed.secret.yaml

cat &lt;&lt; EOF &gt; /data/install/acm.nmsc.yaml
apiVersion: agent-install.openshift.io/v1beta1
kind: NMStateConfig
metadata:
 name: ${ACM_DEMO_CLUSTER}
 namespace: ${ACM_DEMO_CLUSTER}
 labels:
   nmstate-conf-cluster-name: ${ACM_DEMO_CLUSTER}
spec:
 config:
   interfaces:
     - name: ${SNO_IF}
       type: ethernet
       state: up
       ipv4:
         enabled: true
         address:
           - ip: ${SNO_IP}
             prefix-length: ${SNO_NETMAST_S}
         dhcp: false
   dns-resolver:
     config:
       server:
         - ${SNO_DNS}
   routes:
     config:
       - destination: 0.0.0.0/0
         next-hop-address: ${SNO_GW}
         next-hop-interface: ${SNO_IF}
         table-id: 254
 interfaces:
   - name: &quot;${SNO_IF}&quot; 
     macAddress: ${SNO_IF_MAC}
EOF
oc create -f /data/install/acm.nmsc.yaml

cat &lt;&lt; EOF &gt; /data/install/acm.clusterdeployment.yaml
apiVersion: hive.openshift.io/v1
kind: ClusterDeployment
metadata:
  name: ${ACM_DEMO_CLUSTER}
  namespace: ${ACM_DEMO_CLUSTER}
spec:
  baseDomain: ${SNO_BASE_DOMAIN}
  clusterName: ${ACM_DEMO_CLUSTER}
  controlPlaneConfig:
    servingCertificates: {}
  installed: false
  clusterInstallRef:
    group: extensions.hive.openshift.io
    kind: AgentClusterInstall
    name: ${ACM_DEMO_CLUSTER}
    version: v1beta1
  platform:
    agentBareMetal:
      agentSelector:
        matchLabels:
          cluster-name: &quot;${ACM_DEMO_CLUSTER}&quot;
  pullSecretRef:
    name: assisted-deployment-pull-secret
EOF
oc create -f /data/install/acm.clusterdeployment.yaml

oc get ClusterDeployment/${ACM_DEMO_CLUSTER} -n ${ACM_DEMO_CLUSTER} -o json | jq .status | head
# {
#   &quot;conditions&quot;: [
#     {
#       &quot;lastProbeTime&quot;: &quot;2022-04-08T14:58:11Z&quot;,
#       &quot;lastTransitionTime&quot;: &quot;2022-04-08T14:58:11Z&quot;,
#       &quot;message&quot;: &quot;Platform credentials passed authentication check&quot;,
#       &quot;reason&quot;: &quot;PlatformAuthSuccess&quot;,
#       &quot;status&quot;: &quot;False&quot;,
#       &quot;type&quot;: &quot;AuthenticationFailure&quot;
#     },

cat &lt;&lt; EOF &gt; /data/install/acm.agentclusterinstall.yaml
apiVersion: extensions.hive.openshift.io/v1beta1
kind: AgentClusterInstall
metadata:
  name: ${ACM_DEMO_CLUSTER}
  namespace: ${ACM_DEMO_CLUSTER}
  # Only include the annotation if using OVN, otherwise omit the annotation
#   annotations:
#     agent-install.openshift.io/install-config-overrides: '{&quot;networking&quot;:{&quot;networkType&quot;:&quot;OVNKubernetes&quot;}}'
spec:
  clusterDeploymentRef:
    name: ${ACM_DEMO_CLUSTER}
  imageSetRef:
    name: openshift-v4.10.4
  networking:
    clusterNetwork:
      - cidr: &quot;10.128.0.0/14&quot;
        hostPrefix: 23
    serviceNetwork:
      - &quot;172.30.0.0/16&quot;
    machineNetwork:
      - cidr: &quot;192.168.7.0/24&quot;
  provisionRequirements:
    controlPlaneAgents: 1
  sshPublicKey: &quot;$(&lt; ~/.ssh/id_rsa.pub)&quot;
EOF
oc create -f /data/install/acm.agentclusterinstall.yaml
# oc delete -f /data/install/acm.agentclusterinstall.yaml

# wait a moment, and this will be ok
oc get AgentClusterInstall/${ACM_DEMO_CLUSTER} -n ${ACM_DEMO_CLUSTER} -o json | jq .status | head
# {
#   &quot;conditions&quot;: [
#     {
#       &quot;lastProbeTime&quot;: &quot;2022-04-06T13:50:43Z&quot;,
#       &quot;lastTransitionTime&quot;: &quot;2022-04-06T13:50:43Z&quot;,
#       &quot;message&quot;: &quot;SyncOK&quot;,
#       &quot;reason&quot;: &quot;SyncOK&quot;,
#       &quot;status&quot;: &quot;True&quot;,
#       &quot;type&quot;: &quot;SpecSynced&quot;
#     },

cat &lt;&lt; EOF &gt; /data/install/acm.klusterletaddonconfig.yaml
apiVersion: agent.open-cluster-management.io/v1
kind: KlusterletAddonConfig
metadata:
  name: ${ACM_DEMO_CLUSTER}
  namespace: ${ACM_DEMO_CLUSTER}
spec:
  clusterName: ${ACM_DEMO_CLUSTER}
  clusterNamespace: ${ACM_DEMO_CLUSTER}
  clusterLabels:
    cloud: auto-detect
    vendor: auto-detect
  applicationManager:
    enabled: true
  certPolicyController:
    enabled: true
  iamPolicyController:
    enabled: true
  policyController:
    enabled: true
  searchCollector:
    enabled: true 
EOF
oc create -f /data/install/acm.klusterletaddonconfig.yaml

oc get KlusterletAddonConfig/${ACM_DEMO_CLUSTER} -n ${ACM_DEMO_CLUSTER} -o yaml
# apiVersion: agent.open-cluster-management.io/v1
# kind: KlusterletAddonConfig
# metadata:
#   creationTimestamp: &quot;2022-04-06T13:51:19Z&quot;
#   generation: 1
#   name: acm-demo1
#   namespace: acm-demo1
#   resourceVersion: &quot;2187935&quot;
#   uid: 1615ed53-80a3-48d2-823f-8dff08a97d75
# spec:
#   applicationManager:
#     enabled: true
#   certPolicyController:
#     enabled: true
#   clusterLabels:
#     cloud: auto-detect
#     vendor: auto-detect
#   clusterName: acm-demo1
#   clusterNamespace: acm-demo1
#   iamPolicyController:
#     enabled: true
#   policyController:
#     enabled: true
#   searchCollector:
#     enabled: true
# status:
#   conditions:
#   - lastTransitionTime: &quot;2022-04-06T13:51:19Z&quot;
#     message: The cluster is not provisioned by ACM.
#     reason: OCPGlobalProxyNotDetected
#     status: &quot;False&quot;
#     type: OCPGlobalProxyDetected
#   ocpGlobalProxy: {}

cat &lt;&lt; EOF &gt; /data/install/acm.managedcluster.yaml
apiVersion: cluster.open-cluster-management.io/v1
kind: ManagedCluster
metadata:
  name: ${ACM_DEMO_CLUSTER}
spec:
  hubAcceptsClient: true
EOF
oc create -f /data/install/acm.managedcluster.yaml

# 我们是离线安装，所以要定制一下启动配置文件
# generate the ignition

cat &lt;&lt; EOF &gt; /data/sno/ign.base.json
{
  &quot;ignition&quot;: {
    &quot;version&quot;: &quot;3.1.0&quot;
  }
}
EOF

cat &lt;&lt; EOF &gt; /data/sno/install.images.bu
variant: openshift
version: 4.9.0
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-zzz-master-install-images
storage:
  files:
    - path: /etc/containers/registries.conf.d/base.registries.conf
      overwrite: true
      contents:
        inline: |
          unqualified-search-registries = [&quot;registry.access.redhat.com&quot;, &quot;docker.io&quot;]
          short-name-mode = &quot;&quot;

          [[registry]]
            prefix = &quot;&quot;
            location = &quot;quay.io/openshift-release-dev/ocp-release&quot;
            mirror-by-digest-only = true

            [[registry.mirror]]
              location = &quot;${INSTALL_IMAGE_REGISTRY}/ocp4/openshift4&quot;

          [[registry]]
            prefix = &quot;&quot;
            location = &quot;quay.io/openshift-release-dev/ocp-v4.0-art-dev&quot;
            mirror-by-digest-only = true

            [[registry.mirror]]
              location = &quot;${INSTALL_IMAGE_REGISTRY}/ocp4/openshift4&quot;

EOF

cat &lt;&lt; EOF &gt; /data/sno/install.crts.bu
variant: openshift
version: 4.9.0
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-zzz-master-install-crts
storage:
  files:
    - path: /etc/pki/ca-trust/source/anchors/quaylab.crt
      overwrite: true
      contents:
        inline: |
$( cat /etc/crts/redhat.ren.ca.crt | sed 's/^/          /g' )

EOF

mkdir -p /data/sno/disconnected/
# copy ntp related config
/bin/cp -f  /data/ocp4/ocp4-upi-helpernode-master/machineconfig/* /data/sno/disconnected/

# copy image registry proxy related config
cd /data/ocp4
bash image.registries.conf.sh nexus.infra.redhat.ren:8083

/bin/cp -f /data/ocp4/99-worker-container-registries.yaml /data/sno/disconnected/
/bin/cp -f /data/ocp4/99-master-container-registries.yaml /data/sno/disconnected/

cd /data/sno/
# load ignition file generation function
source /data/ocp4/acm.fn.sh


get_file_content_for_ignition &quot;/opt/openshift/openshift/99-master-chrony-configuration.yaml&quot; &quot;/data/sno/disconnected/99-master-chrony-configuration.yaml&quot;
VAR_99_master_chrony=$RET_VAL
VAR_99_master_chrony_2=$RET_VAL_2

get_file_content_for_ignition &quot;/opt/openshift/openshift/99-worker-chrony-configuration.yaml&quot; &quot;/data/sno/disconnected/99-worker-chrony-configuration.yaml&quot;
VAR_99_worker_chrony=$RET_VAL
VAR_99_worker_chrony_2=$RET_VAL_2

get_file_content_for_ignition &quot;/opt/openshift/openshift/99-master-container-registries.yaml&quot; &quot;/data/sno/disconnected/99-master-container-registries.yaml&quot;
VAR_99_master_container_registries=$RET_VAL
VAR_99_master_container_registries_2=$RET_VAL_2

get_file_content_for_ignition &quot;/opt/openshift/openshift/99-worker-container-registries.yaml&quot; &quot;/data/sno/disconnected/99-worker-container-registries.yaml&quot;
VAR_99_worker_container_registries=$RET_VAL
VAR_99_worker_container_registries_2=$RET_VAL_2

butane /data/sno/install.images.bu &gt; /data/sno/disconnected/99-zzz-master-install-images.yaml
get_file_content_for_ignition &quot;/opt/openshift/openshift/99-zzz-master-install-images.yaml&quot; &quot;/data/sno/disconnected/99-zzz-master-install-images.yaml&quot;
VAR_99_master_install_images=$RET_VAL
VAR_99_master_install_images_2=$RET_VAL_2

butane /data/sno/install.crts.bu &gt; /data/sno/disconnected/99-zzz-master-install-crts.yaml
get_file_content_for_ignition &quot;/opt/openshift/openshift/99-zzz-master-install-crts.yaml&quot; &quot;/data/sno/disconnected/99-zzz-master-install-crts.yaml&quot;
VAR_99_master_install_crts=$RET_VAL
VAR_99_master_install_crts_2=$RET_VAL_2

# https://access.redhat.com/solutions/6194821
# butane /data/sno/static.ip.bu | python3 -c 'import json, yaml, sys; print(json.dumps(yaml.load(sys.stdin)))'

# https://stackoverflow.com/questions/2854655/command-to-escape-a-string-in-bash
# VAR_PULL_SEC=`printf &quot;%q&quot; $(cat  /data/pull-secret.json)`

# https://access.redhat.com/solutions/221403
# VAR_PWD_HASH=&quot;$(openssl passwd -1 -salt 'openshift' 'redhat')&quot;
VAR_PWD_HASH=&quot;$(python3 -c 'import crypt,getpass; print(crypt.crypt(&quot;redhat&quot;))')&quot;

tmppath=$(mktemp)
cat /data/sno/ign.base.json \
  | jq --arg VAR &quot;$VAR_PWD_HASH&quot; --arg VAR_SSH &quot;$NODE_SSH_KEY&quot; '.passwd.users += [{ &quot;name&quot;: &quot;wzh&quot;, &quot;system&quot;: true, &quot;passwordHash&quot;: $VAR , &quot;sshAuthorizedKeys&quot;: [ $VAR_SSH ], &quot;groups&quot;: [ &quot;adm&quot;, &quot;wheel&quot;, &quot;sudo&quot;, &quot;systemd-journal&quot;  ] }]' \
  | jq --argjson VAR &quot;$VAR_99_master_chrony&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_worker_chrony&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_master_container_registries&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_worker_container_registries&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_master_chrony_2&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_master_container_registries_2&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_master_install_images_2&quot; '.storage.files += [$VAR] ' \
  | jq --argjson VAR &quot;$VAR_99_master_install_crts_2&quot; '.storage.files += [$VAR] ' \
  | jq -c . \
  &gt; ${tmppath}
VAR_IGNITION=$(cat ${tmppath})
rm -f ${tmppath}


cat &lt;&lt; EOF &gt; /data/install/acm.infraenv.yaml
apiVersion: agent-install.openshift.io/v1beta1
kind: InfraEnv
metadata:
  name: ${ACM_DEMO_CLUSTER}
  namespace: ${ACM_DEMO_CLUSTER}
spec:
  additionalNTPSources:
    - 192.168.7.11
  clusterRef:
    name: ${ACM_DEMO_CLUSTER}
    namespace: ${ACM_DEMO_CLUSTER}
  sshAuthorizedKey: &quot;$(&lt; ~/.ssh/id_rsa.pub)&quot;
  pullSecretRef:
    name: assisted-deployment-pull-secret
  ignitionConfigOverride: '${VAR_IGNITION}'
  nmStateConfigLabelSelector:
    matchLabels:
      nmstate-conf-cluster-name: ${ACM_DEMO_CLUSTER}
  # imageType: &quot;full-iso&quot;
EOF
oc create -f /data/install/acm.infraenv.yaml
# oc delete -f /data/install/acm.infraenv.yaml

oc get infraenv/${ACM_DEMO_CLUSTER} -n ${ACM_DEMO_CLUSTER} -o json | jq .status
# {
#   &quot;agentLabelSelector&quot;: {
#     &quot;matchLabels&quot;: {
#       &quot;infraenvs.agent-install.openshift.io&quot;: &quot;acm-demo1&quot;
#     }
#   },
#   &quot;conditions&quot;: [
#     {
#       &quot;lastTransitionTime&quot;: &quot;2022-04-06T13:52:54Z&quot;,
#       &quot;message&quot;: &quot;Image has been created&quot;,
#       &quot;reason&quot;: &quot;ImageCreated&quot;,
#       &quot;status&quot;: &quot;True&quot;,
#       &quot;type&quot;: &quot;ImageCreated&quot;
#     }
#   ],
#   &quot;createdTime&quot;: &quot;2022-04-06T13:52:54Z&quot;,
#   &quot;debugInfo&quot;: {
#     &quot;eventsURL&quot;: &quot;&quot;
#   },
#   &quot;isoDownloadURL&quot;: &quot;https://assisted-image-service-open-cluster-management.apps.acm-demo-hub.redhat.ren/images/a87141aa-d980-4f34-ba59-d236e2158c98?api_key=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbmZyYV9lbnZfaWQiOiJhODcxNDFhYS1kOTgwLTRmMzQtYmE1OS1kMjM2ZTIxNThjOTgifQ.muD_hlhMIgcNaAZk00M09QW-EwI1REGkxavKo26P-CZ_IkPR3GcdPhWLVtBjdTkrcAOgt__pcWkmJQyko5sqtw&amp;arch=x86_64&amp;type=minimal-iso&amp;version=4.10&quot;
# }


# VAR_ISO=`oc get infraenv ${ACM_DEMO_CLUSTER} -n ${ACM_DEMO_CLUSTER} -o jsonpath={.status.isoDownloadURL}`

# cd /data/install/
# wget --no-check-certificate -O acm.demo1.iso $VAR_ISO

oc get pod -A | grep metal3
# openshift-machine-api                              metal3-6b7b4665f6-knwzr                                           7/7     Running     0               39m
# openshift-machine-api                              metal3-image-cache-hhvnm                                          1/1     Running     1               6h14m
# openshift-machine-api                              metal3-image-customization-577f886bb4-cwl2l                       1/1     Running     1               6h13m

cd /data/ocp4/
cat &lt;&lt; 'EOF' &gt; redfish.sh
#!/usr/bin/env bash

curl -k -s https://192.168.7.1:8000/redfish/v1/Systems/ | jq -r '.Members[].&quot;@odata.id&quot;' &gt;  list

while read -r line; do
    curl -k -s https://192.168.7.1:8000/$line | jq -j '.Id, &quot; &quot;, .Name, &quot;\n&quot; '
done &lt; list

EOF
bash redfish.sh &gt; /data/install/vm.list
cat /data/install/vm.list
# 075b17f7-9be9-4576-8d72-2ddd99909e19 ocp4-acm-demo1-master0
# c991312a-26de-438d-8c2d-6aa6cd586bca ocp4-master0
# e70f66bc-7878-4617-811d-89cdaf62cc8c ocp4-Helper

# oc patch provisioning provisioning-configuration --type merge -p '{&quot;spec&quot;:{&quot;watchAllNamespaces&quot;: true}}'

cat &lt;&lt; EOF &gt; /data/install/acm.demo.secret.bmc.yaml
apiVersion: v1
kind: Secret
metadata:
  name: ${ACM_DEMO_CLUSTER}-bmc-master-0
  namespace: ${ACM_DEMO_CLUSTER}
data:
  password: $(echo password | base64)
  username: $(echo admin | base64)
type: Opaque
EOF
oc create -f /data/install/acm.demo.secret.bmc.yaml

cat &lt;&lt; EOF &gt; /data/install/acm.demo.bmh.master.yaml
apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: ${ACM_DEMO_CLUSTER}-master0
  namespace: ${ACM_DEMO_CLUSTER}
  labels:
    infraenvs.agent-install.openshift.io: &quot;${ACM_DEMO_CLUSTER}&quot;
  annotations:
    ## Disable the Introspection
    inspect.metal3.io: disabled
    ## Set Static Hostname
    bmac.agent-install.openshift.io/hostname: &quot;${SNO_HOSTNAME}&quot;
    ## Set Static Role
    bmac.agent-install.openshift.io/role: &quot;master&quot;
spec:
  online: true
  bmc:
    address: redfish-virtualmedia://192.168.7.1:8000/redfish/v1/Systems/$(cat /data/install/vm.list | grep acm-demo1-master0 | awk '{print $1}')
    credentialsName: ${ACM_DEMO_CLUSTER}-bmc-master-0
    disableCertificateVerification: true
  bootMACAddress: $(cat /data/install/mac.list | grep acm-demo1-master0 | awk '{print $2}')
  automatedCleaningMode: disabled
EOF
oc create -f /data/install/acm.demo.bmh.master.yaml
# oc delete -f /data/install/acm.demo.bmh.master.yaml

</code></pre>
<p>我们回到ACM的界面中，能从基础架构中，看到我们新创建的HOST了，能看到ACM正在通过redfish配置这个kvm
<img src="imgs/2022-03-16-20-10-28.png" alt="" /></p>
<p>这个bare metal host其实是调用的openshift4平台上的服务创建的，所以从openshift4的console上也能看得到：
<img src="imgs/2022-03-16-20-52-54.png" alt="" /></p>
<p>能从openshift4 console上看到这个bare metal host的详细信息：
<img src="imgs/2022-03-16-20-53-28.png" alt="" /></p>
<p><img src="imgs/2022-03-16-20-53-56.png" alt="" /></p>
<p>回到ACM的界面中，我们能看到安装正在继续：
<img src="imgs/2022-03-16-20-54-26.png" alt="" /></p>
<p>从ACM的cluster界面中，我们能看到安装的详细进展情况：
<img src="imgs/2022-03-16-20-55-05.png" alt="" /></p>
<p>但是安装的中途，提示我们需要动手操作一下。这是因为我们是用kvm模拟的物理机，并且模拟了一个redfish，这个redfish功能比较简单，在安装ocp的过程中，kvm会重启，但是远程挂载的光盘没有卸载，所以我们需要卸载掉这个光驱，然后继续安装：
<img src="imgs/2022-03-16-21-57-23.png" alt="" /></p>
<p><img src="imgs/2022-03-16-21-58-06.png" alt="" /></p>
<p>进入kvm的界面，调整一下启动顺序：
<img src="imgs/20220408230353.png" alt="" /></p>
<p>然后重启kvm，等待一段时间，infra env就安装完成了。
<img src="imgs/20220408232630.png" alt="" /></p>
<p>不过，cluster还在继续安装，我们安心等待安装过程完成。</p>
<h2 id="安装完成"><a class="header" href="#安装完成">安装完成</a></h2>
<p>装好了以后，我们在ACM里面就能看到如下景象： https://multicloud-console.apps.acm-demo-hub.redhat.ren/overview</p>
<p><img src="imgs/20220409205421.png" alt="" /></p>
<p>cluster 也能看到了绿色的正常状态了， 这里面local-cluster是ACM hub所在的集群： </p>
<p><img src="imgs/20220409205455.png" alt="" /></p>
<p>看cluster的详细信息，也正常了：</p>
<p>⚠️一定记得，下载kubeconfig文件，还有密码</p>
<p><img src="imgs/20220409211030.png" alt="" /></p>
<p>cluster的node tab也有内容了：</p>
<p><img src="../4.9/imgs/2022-03-14-19-28-14.png" alt="" /></p>
<p>cluster的add-on，也装上了我们之前配置的组件：</p>
<p><img src="imgs/20220409205700.png" alt="" /></p>
<p>infra env也绿色状态了 https://multicloud-console.apps.acm-demo-hub.redhat.ren/multicloud/infra-environments</p>
<p><img src="../4.9/imgs/2022-03-14-19-29-34.png" alt="" /></p>
<p>详细信息和原来一样：</p>
<p><img src="../4.9/imgs/2022-03-14-19-30-16.png" alt="" /></p>
<p>hosts tab 也完成了</p>
<p><img src="../4.9/imgs/2022-03-14-19-30-45.png" alt="" /></p>
<pre><code class="language-bash">
# on helper
useradd -m wzh

su - wzh
mkdir ~/auth

# upload kubeconfig.json to /home/wzh/auth/

ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp=&quot;^export KUBECONFIG&quot; line=&quot;export KUBECONFIG=~/auth/kubeconfig.json&quot;'
source $HOME/.bashrc

</code></pre>
<h1 id="check-dhcp-existed"><a class="header" href="#check-dhcp-existed">check dhcp existed</a></h1>
<p>我们是静态IP安装，那么就要确认一下环境里面是不是真的 DHCP 给关了，检查的方法如下。</p>
<p>https://superuser.com/questions/750359/check-if-a-dhcp-server-existing-in-my-network-using-bash</p>
<pre><code class="language-bash">dnf install nmap -y
nmap --script broadcast-dhcp6-discover -e enp1s0

</code></pre>
<h1 id="end"><a class="header" href="#end">end</a></h1>
<pre><code class="language-bash">
# revert the order
tac &lt;&lt; EOF 
oc delete -f /data/install/acm.ocp.release.yaml
oc delete -f /data/install/acm.cm.asc.yaml
oc delete -f /data/install/acm.secret.yaml
oc delete -f /data/install/acm.mirror.yaml
oc delete -f /data/install/acm.agentservicecofnig.yaml
oc delete -f /data/install/acm.managed.secret.yaml
oc delete -f /data/install/acm.agentclusterinstall.yaml
oc delete -f /data/install/acm.nmsc.yaml
oc delete -f /data/install/acm.clusterdeployment.yaml
oc delete -f /data/install/acm.klusterletaddonconfig.yaml
oc delete -f /data/install/acm.managedcluster.yaml
oc delete -f /data/install/acm.infraenv.yaml
EOF
oc delete -f /data/install/acm.infraenv.yaml
oc delete -f /data/install/acm.managedcluster.yaml
oc delete -f /data/install/acm.klusterletaddonconfig.yaml
oc delete -f /data/install/acm.clusterdeployment.yaml
oc delete -f /data/install/acm.nmsc.yaml
oc delete -f /data/install/acm.agentclusterinstall.yaml
oc delete -f /data/install/acm.managed.secret.yaml
oc delete -f /data/install/acm.agentservicecofnig.yaml
oc delete -f /data/install/acm.mirror.yaml
oc delete -f /data/install/acm.secret.yaml
oc delete -f /data/install/acm.cm.asc.yaml
oc delete -f /data/install/acm.ocp.release.yaml


</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../ocp4/4.10/4.10.disconnect.bm.ipi.sno.static.ip.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../ocp4/4.10/4.10.coreos.boot.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../ocp4/4.10/4.10.disconnect.bm.ipi.sno.static.ip.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../ocp4/4.10/4.10.coreos.boot.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
